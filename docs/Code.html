<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>TB COVID Blantyre: Code</title>
  
  <meta property="description" itemprop="description" content="Code for our Interrupted Time Series Analysis"/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-03-08"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-03-08"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="TB COVID Blantyre: Code"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Code for our Interrupted Time Series Analysis"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="TB COVID Blantyre"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="TB COVID Blantyre: Code"/>
  <meta property="twitter:description" content="Code for our Interrupted Time Series Analysis"/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","date","output"]}},"value":[{"type":"character","attributes":{},"value":["Code"]},{"type":"character","attributes":{},"value":["Code for our Interrupted Time Series Analysis\n"]},{"type":"character","attributes":{},"value":["2021-03-08"]},{"type":"character","attributes":{},"value":["distill::distill_article"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>
  
  <script type="application/javascript">
  
    window.headroom_prevent_pin = false;
  
    window.document.addEventListener("DOMContentLoaded", function (event) {
  
      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');
  
      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });
  
      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });
  
      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>
  
  <style type="text/css">
  
  /* Theme (user-documented overrideables for nav appearance) */
  
  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }
  
  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }
  
  .distill-site-nav a:hover {
    color: white;
  }
  
  @media print {
    .distill-site-nav {
      display: none;
    }
  }
  
  .distill-site-header {
  
  }
  
  .distill-site-footer {
  
  }
  
  
  /* Site Header */
  
  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }
  
  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }
  
  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }
  
  
  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }
  
  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }
  
  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }
  
  .distill-site-header .logo {
    padding: 0;
  }
  
  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }
  
  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }
  
  
  
  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }
  
  
  .distill-site-header .nav-toggle {
    display: none;
  }
  
  .nav-dropdown {
    display: inline-block;
    position: relative;
  }
  
  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }
  
  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }
  
  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .nav-dropdown-active {
    display: block;
  }
  
  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }
  
  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }
  
  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }
  
  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }
  
  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }
  
  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }
  
  
  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }
  
  /* Site Footer */
  
  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }
  
  /* Headroom */
  
  d-title {
    padding-top: 6rem;
  }
  
  @media print {
    d-title {
      padding-top: 4rem;
    }
  }
  
  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  
  .headroom--transition {
    transition: all .4s ease-in-out;
  }
  
  .headroom--unpinned {
    top: -100px;
  }
  
  .headroom--pinned {
    top: 0;
  }
  
  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }
  
  </style>
  
  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>
  
  <script type="application/javascript">
  
  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }
  
  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }
  
  function createFuseIndex() {
  
    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);
  
    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });
  
        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }
  
  window.document.addEventListener("DOMContentLoaded", function (event) {
  
    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;
  
    createFuseIndex()
      .then(function(fuse) {
  
        // make search box visible
        searchEl.classList.remove('hidden');
  
        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });
  
  });
  
  </script>
  
  <style type="text/css">
  
  .nav-search {
    font-size: x-small;
  }
  
  /* Algolioa Autocomplete */
  
  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }
  
  
  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }
  
  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }
  
  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }
  
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }
  
  </style>
  
  
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }
  
  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }
  
  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }
  
  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }
  
  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }
  
  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }
  
  d-article h3 {
    margin-top: 1.5rem;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  /* Tweak code blocks */
  
  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }
  
  d-article div.sourceCode {
    background-color: white;
  }
  
  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  d-article pre a {
    border-bottom: none;
  }
  
  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }
  
  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }
  
  @media(min-width: 768px) {
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }
  
  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }
  
  d-article pre {
    font-size: 14px;
  }
  
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for d-contents */
  
  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }
  
  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }
  
  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }
  
  .d-contents li {
    list-style-type: none
  }
  
  .d-contents nav > ul {
    padding-left: 0;
  }
  
  .d-contents ul {
    padding-left: 1em
  }
  
  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }
  
  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }
  
  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }
  
  .d-contents nav > ul > li > a {
    font-weight: 600;
  }
  
  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }
  
  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }
  
  
  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }
  
  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }
  
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  /* Citations */
  
  d-article .citation {
    color: inherit;
    cursor: inherit;
  }
  
  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }
  
  /* Citation hover box */
  
  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }
  
  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* Include appendix styles here so they can be overridden */
  
  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }
  
  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }
  
  d-appendix h3 + * {
    margin-top: 1em;
  }
  
  d-appendix ol {
    padding: 0 0 0 15px;
  }
  
  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }
  
  d-appendix li {
    margin-bottom: 1em;
  }
  
  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  d-appendix > * {
    grid-column: text;
  }
  
  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }
  
  /* Include footnote styles here so they can be overridden */
  
  d-footnote-list {
    contain: layout style;
  }
  
  d-footnote-list > * {
    grid-column: text;
  }
  
  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }
  
  
  
  /* Anchor.js */
  
  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .custom p {
    margin-bottom: 0.5em;
  }
  
  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }
  
  /* Styles for posts lists (not auto-injected) */
  
  
  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }
  
  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }
  
  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }
  
  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }
  
  .post-preview-last {
    border-bottom: none !important;
  }
  
  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }
  
  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }
  
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }
  
  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }
  
  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }
  
  .posts-list .metadata > * {
    display: inline-block;
  }
  
  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }
  
  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }
  
  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }
  
  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  .posts-list img {
    opacity: 1;
  }
  
  .posts-list img[data-src] {
    opacity: 0;
  }
  
  .posts-more {
    clear: both;
  }
  
  
  .posts-sidebar {
    font-size: 16px;
  }
  
  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }
  
  .sidebar-section {
    margin-bottom: 30px;
  }
  
  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  
  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }
  
  .categories li>a {
    border-bottom: none;
  }
  
  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }
  
  .categories .active {
    font-weight: 600;
  }
  
  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }
  
  
  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  .downlevel .posts-list .post-preview {
    color: inherit;
  }
  
  
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }
  
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();
  
    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-contents').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <style type="text/css">
  /* --------------Navbar-------------------- */
  
  .distill-site-header{ 
    background-color: #3EB489;
  }
  </style>
  <!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Code","description":"Code for our Interrupted Time Series Analysis","authors":[],"publishedDate":"2021-03-08T00:00:00.000+00:00"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">TB COVID Blantyre</a>
<a href="Code.html">Code</a>
</div>
<div class="nav-right">
<a href="index.html">Home</a>
<a href="about.html">About</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Code</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>Code for our Interrupted Time Series Analysis</p></p>
</div>


<div class="d-article">
<h1 id="load-packages-and-data">1. Load packages and data</h1>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Packages</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.stats.ox.ac.uk/pub/MASS4/'>MASS</a></span>, exclude<span class='op'>=</span><span class='st'>"select"</span><span class='op'>)</span> <span class='co'># for glm.nb</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://readxl.tidyverse.org'>readxl</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://broom.tidymodels.org/'>broom</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://here.r-lib.org/'>here</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/rstudio/gt'>gt</a></span><span class='op'>)</span> <span class='co'># make tables loook nice</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://stringr.tidyverse.org'>stringr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tsModel</span><span class='op'>)</span> <span class='co'>#for including harmonic fx for seasonality</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>boot</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/amices/mice'>mice</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/sfirke/janitor'>janitor</a></span><span class='op'>)</span> <span class='co'>#for tabyl</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://zoo.R-Forge.R-project.org/'>zoo</a></span><span class='op'>)</span> <span class='co'>#for na.approx (interpolate values of population when month treated continuously)</span>

<span class='co'># Load the data</span>

<span class='va'>tb_data_group</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>,<span class='st'>"tb_data_group.csv"</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/load.html'>load</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data/Pop_Age_Sex_HIV.rdata"</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># Blantyre census data disaggregated by age and sex (from world population prospects and modified by CCK)</span>
<span class='va'>cens</span> <span class='op'>&lt;-</span> <span class='va'>PopQ</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>year_q<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='va'>Year</span>,<span class='st'>":"</span>,<span class='va'>Q</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>yq<span class='op'>=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>yq</a></span><span class='op'>(</span><span class='va'>year_q</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># yq is a date with 1st day of each quarter</span>

<span class='va'>age_levels_10</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"0-14"</span>,<span class='st'>"15-24"</span>, <span class='st'>"25-34"</span>, <span class='st'>"35-44"</span>, <span class='st'>"45-54"</span>, <span class='st'>"55-64"</span>, <span class='st'>"65+"</span><span class='op'>)</span>
<span class='va'>covid_date_m</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 Apr 2020"</span><span class='op'>)</span> <span class='co'># date of COVID starting (whole month)</span>
</code></pre>
</div>
</div>
<p>Define some functions for use later</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># These functions takes a model and makes predictions and puts them into a dataframe (including counterfactual no-COVID)</span>

<span class='co'># The first functions give a df containing one observation per month and predictions for all the levels contained in data plus a counterfactual "no COVID" time.  This is used for calculating expected cumlative numbers of TB cases / CNR (particularly in counterfactual months).</span>

<span class='co'># In second function month is not integer-coded but is continuous -- this is for plotting the graphs so that there is an instaneous effect of COVID (with integer-coded months the drop between March and April was a diagonal line on the graph connecting March and April 2020, which didn't make sense as we'd modelled an instaneneous drop)</span>

<span class='va'>model2pred_pop</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>m</span><span class='op'>)</span><span class='op'>{</span> <span class='co'>#incorporating a population term to give CNRs</span>

<span class='va'>scaffold_df</span> <span class='op'>&lt;-</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>expand</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'>#makes predictions over every level that exists in the data</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>all</span><span class='op'>%&gt;%</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>month_num</span>,<span class='va'>pop</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>pred_obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m</span>, type<span class='op'>=</span><span class='st'>"link"</span>, newdata<span class='op'>=</span><span class='va'>scaffold_df</span>, se.fit<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>

<span class='va'>df1</span> <span class='op'>&lt;-</span> <span class='va'>scaffold_df</span> <span class='op'>%&gt;%</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>all</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>cases_actual<span class='op'>=</span><span class='va'>cases</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>cnr_actual<span class='op'>=</span><span class='va'>cnr</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_pred<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_pred<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>*</span> <span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_low<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_high<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_low<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
    <span class='op'>)</span>
    <span class='op'>*</span><span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span> <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_high<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>*</span><span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_se<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_link<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span> <span class='co'>#need to have this on link scale to bootstrap later</span>

<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='va'>df1</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>irrelevant<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
    <span class='va'>covid</span><span class='op'>==</span><span class='fl'>1</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&lt;</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>,
    <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>irrelevant</span><span class='op'>!=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>  <span class='co'>#get rid of "COVID"=yes when time is before COVID (irrelevant predictions)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>irrelevant</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>c_fact<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
        <span class='va'>covid</span><span class='op'>==</span><span class='fl'>0</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&gt;=</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>, <span class='co'>#create a variable to indicate no-COVID by after COVID-time is counterfactual</span>
        <span class='cn'>T</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span>
<span class='va'>df2</span>
<span class='op'>}</span>

<span class='va'>model2pred_pop_continuous</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>m</span><span class='op'>)</span><span class='op'>{</span> <span class='co'>#incorporating a population term to give CNRs</span>

<span class='va'>seq</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span>, length<span class='op'>=</span><span class='fl'>100</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='op'>)</span> <span class='co'># creates 100 data point between start and end month numbers (i.e. "month num" becomes nearly continuous)</span>

<span class='va'>expand_months</span> <span class='op'>&lt;-</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>expand</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>, <span class='va'>seq</span><span class='op'>$</span><span class='va'>.</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># now includes 1000 extra points for each level of covid and month_num</span>
  <span class='fu'>mutate</span><span class='op'>(</span>month_num<span class='op'>=</span><span class='va'>`seq$.`</span> <span class='op'>+</span> <span class='va'>month_num</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># makes a 'continous' variable for month_num (have to keep name month_num so that plotting works as that's the variable name in model)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>`seq$.`</span><span class='op'>)</span>

<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>, <span class='va'>month</span><span class='op'>)</span> <span class='co'># I need this to get actual months back, not just month_num</span>

<span class='va'>expand_pop</span> <span class='op'>&lt;-</span> <span class='va'>expand_months</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>all</span>, by<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"month_num"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid.x</span>, <span class='va'>pop</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>covid<span class='op'>=</span><span class='va'>covid.x</span><span class='op'>)</span><span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/zoo/man/na.approx.html'>na.approx</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>  <span class='co'># from zoo package, linear interpolation of population between quarters (to match months now being effectively continuous)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>

<span class='va'>scaffold_df_continuous</span> <span class='op'>&lt;-</span> <span class='va'>expand_pop</span>

<span class='va'>pred_obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m</span>, type<span class='op'>=</span><span class='st'>"link"</span>, newdata<span class='op'>=</span><span class='va'>scaffold_df_continuous</span>, se.fit<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>

<span class='va'>df1</span> <span class='op'>&lt;-</span> <span class='va'>scaffold_df_continuous</span> <span class='op'>%&gt;%</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>all</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># this brings calendar month back but only when COVID=</span>
  <span class='fu'>rename</span><span class='op'>(</span>cases_actual<span class='op'>=</span><span class='va'>cases</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>cnr_actual<span class='op'>=</span><span class='va'>cnr</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_pred<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_pred<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>*</span> <span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_low<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_high<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_low<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
    <span class='op'>)</span>
    <span class='op'>*</span><span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span> <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr_high<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
    <span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>*</span><span class='fl'>100000</span> <span class='op'>*</span> <span class='fl'>12</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_se<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_link<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span> <span class='co'>#need to have this on link scale to bootstrap later</span>

<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='va'>df1</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>irrelevant<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
    <span class='va'>covid</span><span class='op'>==</span><span class='fl'>1</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&lt;</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>,
    <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>irrelevant</span><span class='op'>!=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>  <span class='co'>#get rid of "COVID"=yes when time is before COVID (irrelevant predictions)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>irrelevant</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>c_fact<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
        <span class='va'>covid</span><span class='op'>==</span><span class='fl'>0</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&gt;=</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>, <span class='co'>#create a variable to indicate no-COVID by after COVID-time is counterfactual</span>
        <span class='cn'>T</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span>
<span class='va'>df2</span>
<span class='op'>}</span>


<span class='va'>model2pred_by</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>m</span><span class='op'>)</span><span class='op'>{</span> 

<span class='va'>scaffold_df</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>!=</span><span class='st'>"unknown"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>)</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>,<span class='va'>fac</span>,<span class='va'>hiv</span>,<span class='va'>sex</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>expand</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>,<span class='va'>fac</span>,<span class='va'>hiv</span>,<span class='va'>sex</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'>#makes predictions over every level</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>by</span><span class='op'>%&gt;%</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>month_num</span><span class='op'>)</span><span class='op'>%&gt;%</span><span class='fu'>distinct</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>pred_obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m</span>, type<span class='op'>=</span><span class='st'>"link"</span>, newdata<span class='op'>=</span><span class='va'>scaffold_df</span>, se.fit<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>

<span class='va'>df1</span> <span class='op'>&lt;-</span> <span class='va'>scaffold_df</span> <span class='op'>%&gt;%</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>cases_actual<span class='op'>=</span><span class='va'>cases</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_pred<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_low<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_high<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_se<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_link<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span> <span class='co'>#need to have this on link scale to bootstrap later</span>

<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='va'>df1</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>irrelevant<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
    <span class='va'>covid</span><span class='op'>==</span><span class='fl'>1</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&lt;</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>,
    <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>irrelevant</span><span class='op'>!=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>  <span class='co'>#get rid of "COVID"=yes when time is before COVID (irrelevant predictions)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>irrelevant</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>c_fact<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
        <span class='va'>covid</span><span class='op'>==</span><span class='fl'>0</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&gt;=</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>, 
        <span class='cn'>T</span> <span class='op'>~</span> <span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>df2</span>
<span class='op'>}</span>

<span class='va'>model2pred_by_continuous</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>m</span><span class='op'>)</span><span class='op'>{</span> 

  <span class='va'>seq</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span>, length<span class='op'>=</span><span class='fl'>100</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='op'>)</span> <span class='co'># creates 100 data point between start and end month numbers (i.e. "month num" becomes nearly continuous)</span>

  <span class='va'>expand_months</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>expand</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>, <span class='va'>seq</span><span class='op'>$</span><span class='va'>.</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># now includes 1000 extra points for each level of covid and month_num</span>
  <span class='fu'>mutate</span><span class='op'>(</span>month_num<span class='op'>=</span><span class='va'>`seq$.`</span> <span class='op'>+</span> <span class='va'>month_num</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'># makes a 'continous' variable for month_num (have to keep name month_num so that plotting works as that's the variable name in model)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>`seq$.`</span><span class='op'>)</span>
  
  <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>!=</span><span class='st'>"unknown"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>)</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> 
  
  <span class='va'>scaffold_df</span> <span class='op'>&lt;-</span> <span class='va'>expand_months</span> <span class='op'>%&gt;%</span> <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>,<span class='va'>fac</span>,<span class='va'>hiv</span>,<span class='va'>sex</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>expand</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='va'>covid</span>,<span class='va'>fac</span>,<span class='va'>hiv</span>,<span class='va'>sex</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'>#makes predictions over every level</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>by</span><span class='op'>%&gt;%</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>month_num</span><span class='op'>)</span><span class='op'>%&gt;%</span><span class='fu'>distinct</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>pred_obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>m</span>, type<span class='op'>=</span><span class='st'>"link"</span>, newdata<span class='op'>=</span><span class='va'>scaffold_df</span>, se.fit<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>

<span class='va'>df1</span> <span class='op'>&lt;-</span> <span class='va'>scaffold_df</span> <span class='op'>%&gt;%</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>rename</span><span class='op'>(</span>cases_actual<span class='op'>=</span><span class='va'>cases</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_pred<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_low<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_high<span class='op'>=</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_se<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>se.fit</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cases_link<span class='op'>=</span><span class='va'>pred_obj</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span> <span class='co'>#need to have this on link scale to bootstrap later</span>


<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='va'>df1</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>irrelevant<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
    <span class='va'>covid</span><span class='op'>==</span><span class='fl'>1</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&lt;</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>,
    <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='cn'>F</span>
  <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>irrelevant</span><span class='op'>!=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>  <span class='co'>#get rid of "COVID"=yes when time is before COVID (irrelevant predictions)</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>irrelevant</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>c_fact<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
        <span class='va'>covid</span><span class='op'>==</span><span class='fl'>0</span> <span class='op'>&amp;</span> <span class='va'>month_num</span> <span class='op'>&gt;=</span> <span class='va'>covid_month_num</span> <span class='op'>~</span> <span class='cn'>T</span>, 
        <span class='cn'>T</span> <span class='op'>~</span> <span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>df2</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<h1 id="get-data-into-required-format">2. Get data into required format</h1>
<p>NB. All is grouped data of total number of TB cases by month.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tb_data</span> <span class='op'>&lt;-</span> <span class='va'>tb_data_group</span> <span class='op'>%&gt;%</span> <span class='fu'>uncount</span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>month<span class='op'>=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>fac<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>fac</span><span class='op'>)</span>,
                                                                                sex <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>)</span>,
                                                                                hiv <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>cens_10yr</span> <span class='op'>&lt;-</span> <span class='va'>cens</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>age_gp<span class='op'>=</span><span class='fu'>case_when</span><span class='op'>(</span>
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[0,4)"</span> <span class='op'>~</span> <span class='st'>"0-14"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[5,9)"</span> <span class='op'>~</span> <span class='st'>"0-14"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[10,14)"</span> <span class='op'>~</span> <span class='st'>"0-14"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[15,19)"</span> <span class='op'>~</span> <span class='st'>"15-24"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[20,24)"</span> <span class='op'>~</span> <span class='st'>"15-24"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[25,29)"</span> <span class='op'>~</span> <span class='st'>"25-34"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[30,34)"</span> <span class='op'>~</span> <span class='st'>"25-34"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[35,39)"</span> <span class='op'>~</span> <span class='st'>"35-44"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[40,44)"</span> <span class='op'>~</span> <span class='st'>"35-44"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[45,49)"</span> <span class='op'>~</span> <span class='st'>"45-54"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[50,54)"</span> <span class='op'>~</span> <span class='st'>"45-54"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[55,59)"</span> <span class='op'>~</span> <span class='st'>"55-64"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[60,64)"</span> <span class='op'>~</span> <span class='st'>"55-64"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[60,64)"</span> <span class='op'>~</span> <span class='st'>"55-64"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[65,69)"</span> <span class='op'>~</span> <span class='st'>"65+"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[70,74)"</span> <span class='op'>~</span> <span class='st'>"65+"</span>,
  <span class='va'>Age</span><span class='op'>==</span><span class='st'>"[75, )"</span> <span class='op'>~</span> <span class='st'>"65+"</span>
<span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>yq</span>, <span class='va'>age_gp</span>, <span class='va'>Sex</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>pop<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>Population</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>cens_all</span> <span class='op'>&lt;-</span> <span class='va'>cens</span> <span class='op'>%&gt;%</span>
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>yq</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>pop<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>Population</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>`0`<span class='op'>=</span><span class='va'>pop</span>,  <span class='co'># so this is a slightly hacky way to get population demoninators for each month (the quarter denominator gets repeated the same three times, not ideal, but it doesn't make any difference.  For plotting the graph - where CNR is a continous variable, I interpolate population to avoid zigzags)</span>
         `1`<span class='op'>=</span><span class='va'>pop</span>,
         `2`<span class='op'>=</span><span class='va'>pop</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pivot_longer</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>`0`</span>,<span class='va'>`1`</span>,<span class='va'>`2`</span><span class='op'>)</span>,names_to<span class='op'>=</span><span class='st'>"m"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>m<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>month<span class='op'>=</span><span class='va'>yq</span><span class='op'>+</span><span class='fu'><a href='https://rdrr.io/r/base/weekday.POSIXt.html'>months</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># then this is dataframe lumping all cases togehter</span>
<span class='va'>all</span> <span class='op'>&lt;-</span> <span class='va'>tb_data</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>cases<span class='op'>=</span><span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'>#generates cases per month</span>
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>covid <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>month</span> <span class='op'>&gt;=</span> <span class='va'>covid_date_m</span>, <span class='fl'>1L</span>,<span class='fl'>0L</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>month_num <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='co'>#create a month_num variable to use in model (rather than actual date, so coefficients make sense)</span>
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>cens_all</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>cnr<span class='op'>=</span><span class='op'>(</span><span class='va'>cases</span><span class='op'>/</span><span class='va'>pop</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>100000</span><span class='op'>*</span><span class='fl'>12</span><span class='op'>)</span> <span class='co'># x12 to get annualised CNRs (NB. children included in both denominator and numerator here)</span>

<span class='va'>covid_month_num</span> <span class='op'>&lt;-</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>==</span><span class='va'>covid_date_m</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>month_num</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>distinct</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span> <span class='co'># this is to that models stay correct even if choose to change "covid_date_m"</span>
</code></pre>
</div>
</div>
<h2 id="demographics">Demographics</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 1
  `sum(cases)`
         &lt;int&gt;
1        10274</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tb_data</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 10274</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid_m</span> <span class='op'>&lt;-</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&lt;=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 March 2020"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>b4covid</span> <span class='op'>&lt;-</span> <span class='va'>tb_data</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&lt;=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 March 2020"</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>b4covid_m</span> <span class='op'>%&gt;%</span> <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>cnr</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>slice_tail</span><span class='op'>(</span>n<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 9
  month      cases covid month_num yq            pop     m  value
  &lt;date&gt;     &lt;int&gt; &lt;int&gt;     &lt;int&gt; &lt;date&gt;      &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 2016-11-01   259     0         6 2016-10-01 7.67e5     1 7.67e5
#  with 1 more variable: cnr &lt;dbl&gt;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid_m</span> <span class='op'>%&gt;%</span> <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>cnr</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>slice_head</span><span class='op'>(</span>n<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 9
  month      cases covid month_num yq            pop     m  value
  &lt;date&gt;     &lt;int&gt; &lt;int&gt;     &lt;int&gt; &lt;date&gt;      &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 2019-10-01    95     0        41 2019-10-01 8.33e5     0 8.33e5
#  with 1 more variable: cnr &lt;dbl&gt;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 9199</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/janitor/man/tabyl.html'>tabyl</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>    sex    n     percent valid_percent
 female 3561 0.387107294     0.3882468
   male 5611 0.609957604     0.6117532
   &lt;NA&gt;   27 0.002935102            NA</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/janitor/man/tabyl.html'>tabyl</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>      hiv    n    percent valid_percent
 negative 3279 0.35645179     0.3603693
 positive 5820 0.63267746     0.6396307
     &lt;NA&gt;  100 0.01087075            NA</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>b4covid</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/janitor/man/tabyl.html'>tabyl</a></span><span class='op'>(</span><span class='va'>fac</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  fac    n   percent
   hc 4310 0.4685292
 qech 4889 0.5314708</code></pre>
</div>
<h2 id="model-for-all-tb-cases">Model for all TB cases</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb</span> <span class='op'>&lt;-</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/glm.nb.html'>glm.nb</a></span><span class='op'>(</span><span class='va'>cases</span> <span class='op'>~</span> <span class='va'>covid</span> <span class='op'>+</span> <span class='va'>month_num</span> <span class='op'>+</span> <span class='va'>covid</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/AsIs.html'>I</a></span><span class='op'>(</span><span class='va'>month_num</span><span class='op'>-</span><span class='va'>covid_month_num</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>all</span><span class='op'>)</span>

<span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m1_nb</span>, exp<span class='op'>=</span><span class='cn'>T</span>, conf.int <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/gt/man/gt.html'>gt</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#gmnmbynktd .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#gmnmbynktd .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gmnmbynktd .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#gmnmbynktd .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#gmnmbynktd .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gmnmbynktd .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gmnmbynktd .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#gmnmbynktd .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#gmnmbynktd .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#gmnmbynktd .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#gmnmbynktd .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#gmnmbynktd .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#gmnmbynktd .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#gmnmbynktd .gt_from_md > :first-child {
  margin-top: 0;
}

#gmnmbynktd .gt_from_md > :last-child {
  margin-bottom: 0;
}

#gmnmbynktd .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#gmnmbynktd .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#gmnmbynktd .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gmnmbynktd .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#gmnmbynktd .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gmnmbynktd .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#gmnmbynktd .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#gmnmbynktd .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gmnmbynktd .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gmnmbynktd .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#gmnmbynktd .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gmnmbynktd .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#gmnmbynktd .gt_left {
  text-align: left;
}

#gmnmbynktd .gt_center {
  text-align: center;
}

#gmnmbynktd .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#gmnmbynktd .gt_font_normal {
  font-weight: normal;
}

#gmnmbynktd .gt_font_bold {
  font-weight: bold;
}

#gmnmbynktd .gt_font_italic {
  font-style: italic;
}

#gmnmbynktd .gt_super {
  font-size: 65%;
}

#gmnmbynktd .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="gmnmbynktd" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">conf.low</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">conf.high</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">0.0003236993</td>
      <td class="gt_row gt_right">0.039372603</td>
      <td class="gt_row gt_right">-204.093577</td>
      <td class="gt_row gt_right">0.000000e+00</td>
      <td class="gt_row gt_right">0.0002996355</td>
      <td class="gt_row gt_right">0.000349907</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">covid</td>
      <td class="gt_row gt_right">0.6403553658</td>
      <td class="gt_row gt_right">0.099365146</td>
      <td class="gt_row gt_right">-4.485798</td>
      <td class="gt_row gt_right">7.264146e-06</td>
      <td class="gt_row gt_right">0.5266200632</td>
      <td class="gt_row gt_right">0.779310109</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">month_num</td>
      <td class="gt_row gt_right">0.9889841145</td>
      <td class="gt_row gt_right">0.001479681</td>
      <td class="gt_row gt_right">-7.486080</td>
      <td class="gt_row gt_right">7.096098e-14</td>
      <td class="gt_row gt_right">0.9861008442</td>
      <td class="gt_row gt_right">0.991873419</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0439775426</td>
      <td class="gt_row gt_right">0.018821477</td>
      <td class="gt_row gt_right">2.286642</td>
      <td class="gt_row gt_right">2.221673e-02</td>
      <td class="gt_row gt_right">1.0058566856</td>
      <td class="gt_row gt_right">1.083617001</td>
    </tr>
  </tbody>
  
  
</table></div>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>coeff</span> <span class='op'>&lt;-</span> <span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m1_nb</span>, exp<span class='op'>=</span><span class='cn'>T</span>, conf.int <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span>

<span class='fl'>1</span> <span class='op'>-</span> <span class='va'>coeff</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span>
</code></pre>
</div>
<pre><code>   estimate
1 0.3596446</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>coeff</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>6</span><span class='op'>]</span>
</code></pre>
</div>
<pre><code>   conf.low
1 0.4733799</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>coeff</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>7</span><span class='op'>]</span>
</code></pre>
</div>
<pre><code>  conf.high
1 0.2206899</code></pre>
</div>
Make and plot predictions
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb_all</span> <span class='op'>&lt;-</span> <span class='fu'>model2pred_pop</span><span class='op'>(</span><span class='va'>all</span>,<span class='va'>m1_nb</span><span class='op'>)</span> <span class='co'>#this is used to make cumulative predictions</span>

<span class='va'>m1_nb_all_continuous</span> <span class='op'>&lt;-</span> <span class='fu'>model2pred_pop_continuous</span><span class='op'>(</span><span class='va'>all</span>,<span class='va'>m1_nb</span><span class='op'>)</span> <span class='co'># this is used to plot</span>

<span class='co'># Plotting the whole timescale (treating time as continuous)</span>

<span class='co'># the below bit of code (and 'plot df' is a slightly hack-y way to make 'seq' correspond to real dates to be able to plot)</span>
<span class='va'>cT</span> <span class='op'>&lt;-</span> <span class='va'>m1_nb_all_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='co'># creating a sequence of dates to match month_num (a continuous numerical value)</span>
<span class='va'>start_cT</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>cT</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>
<span class='va'>end_cT</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>cT</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/weekday.POSIXt.html'>months</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='co'># the end date needs to be the END of the month, not the start of the month</span>
<span class='va'>length_cT</span> <span class='op'>&lt;-</span> <span class='va'>cT</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>seq_cT</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.Date.html'>seq.Date</a></span><span class='op'>(</span><span class='va'>start_cT</span>,<span class='va'>end_cT</span>,length.out <span class='op'>=</span> <span class='va'>length_cT</span><span class='op'>)</span> 

<span class='va'>cF</span> <span class='op'>&lt;-</span> <span class='va'>m1_nb_all_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span>
<span class='va'>start_cF</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>cF</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>
<span class='va'>end_cF</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>cF</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/weekday.POSIXt.html'>months</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>
<span class='va'>length_cF</span> <span class='op'>&lt;-</span> <span class='va'>cF</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>seq_cF</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.Date.html'>seq.Date</a></span><span class='op'>(</span><span class='va'>start_cF</span>,<span class='va'>end_cF</span>,length.out <span class='op'>=</span> <span class='va'>length_cF</span><span class='op'>)</span> 

<span class='va'>seq</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>seq_cF</span>, <span class='va'>seq_cT</span><span class='op'>)</span>

<span class='va'>plot_df</span> <span class='op'>&lt;-</span> <span class='va'>m1_nb_all_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>c_fact</span>,<span class='va'>month_num</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>seq</span><span class='op'>)</span> <span class='co'># "plot df" has month_num transformed to actual date</span>

<span class='co'># Plot observed values and predictions</span>
<span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_rect</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xmin<span class='op'>=</span><span class='va'>covid_date_m</span>, xmax<span class='op'>=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"15 Dec 2020"</span><span class='op'>)</span>, ymin<span class='op'>=</span><span class='op'>-</span><span class='cn'>Inf</span>, ymax<span class='op'>=</span><span class='cn'>Inf</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.1</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_pred</span>, x<span class='op'>=</span><span class='va'>seq</span>, linetype<span class='op'>=</span><span class='st'>"observed"</span>, color<span class='op'>=</span><span class='st'>"observed"</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>plot_df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_ribbon</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>ymax<span class='op'>=</span><span class='va'>cnr_high</span>, ymin<span class='op'>=</span><span class='va'>cnr_low</span>, x<span class='op'>=</span><span class='va'>seq</span>, fill<span class='op'>=</span><span class='st'>"observed"</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span>, data<span class='op'>=</span><span class='va'>plot_df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_pred</span>, x<span class='op'>=</span><span class='va'>seq</span>, linetype<span class='op'>=</span><span class='st'>"counterfactual"</span>, color<span class='op'>=</span><span class='st'>"counterfactual"</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>plot_df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_ribbon</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>ymax<span class='op'>=</span><span class='va'>cnr_high</span>, ymin<span class='op'>=</span><span class='va'>cnr_low</span>, x<span class='op'>=</span><span class='va'>seq</span>, fill<span class='op'>=</span><span class='st'>"counterfactual"</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span>, data<span class='op'>=</span><span class='va'>plot_df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_actual</span>, x<span class='op'>=</span><span class='va'>month</span><span class='op'>+</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>15</span><span class='op'>)</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>plot_df</span>, shape<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> <span class='co'># plot actual numbers on 15th each month</span>
  <span class='co'>#geom_vline(aes(xintercept=covid_date_m)) +</span>
  <span class='fu'>scale_linetype_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>,values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"dashed"</span>,<span class='st'>"solid"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_fill_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#DE3163"</span>,<span class='st'>"#3FE0D0"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_color_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#DE3163"</span>,<span class='st'>"#4286f4"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Case Notification Rate (per 100,000 person-years)"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Month and Year"</span><span class='op'>)</span> <span class='op'>+</span>
   <span class='fu'>labs</span><span class='op'>(</span>title<span class='op'>=</span><span class='st'>"Blantyre TB Case Notifcation Rate"</span>,
       caption<span class='op'>=</span><span class='st'>"CNR = Cases TB notified per 100,000 person-years, \n Dots = observed case notification rate \n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \n Shaded area indicates time that COVID emergency was declared in Malawi"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>coord_cartesian</span><span class='op'>(</span>xlim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 April 2016"</span><span class='op'>)</span>, <span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"15 Dec 2020"</span><span class='op'>)</span><span class='op'>)</span>,ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>430</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_x_date</span><span class='op'>(</span>expand <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span>  <span class='op'>%+replace%</span>
    <span class='fu'>theme</span><span class='op'>(</span>legend.title <span class='op'>=</span> <span class='fu'>element_blank</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="Code_files/figure-html5/unnamed-chunk-3-1.png" width="624" /></p>
</div>
<p>And some examples of predications from model</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb_all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>==</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 March 2020"</span><span class='op'>)</span> <span class='op'>|</span> <span class='va'>month</span><span class='op'>==</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 April 2020"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>month_num</span>, <span class='op'>-</span><span class='va'>yq</span>, <span class='op'>-</span><span class='va'>m</span>, <span class='op'>-</span><span class='va'>pop</span>, <span class='op'>-</span><span class='va'>value</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 3 x 13
  covid month      cases_actual cnr_actual cases_pred cnr_pred
  &lt;int&gt; &lt;date&gt;            &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1     0 2020-03-01          168       240.       163.     233.
2     0 2020-04-01           NA        NA        162.     231.
3     1 2020-04-01          107       152.       104.     148.
#  with 7 more variables: cases_low &lt;dbl&gt;, cases_high &lt;dbl&gt;,
#   cnr_low &lt;dbl&gt;, cnr_high &lt;dbl&gt;, cases_se &lt;dbl&gt;, cases_link &lt;dbl&gt;,
#   c_fact &lt;lgl&gt;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb_all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>==</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 Nov 2020"</span><span class='op'>)</span> <span class='op'>|</span> <span class='va'>month</span><span class='op'>==</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 Dec 2020"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>month_num</span>, <span class='op'>-</span><span class='va'>yq</span>, <span class='op'>-</span><span class='va'>m</span>, <span class='op'>-</span><span class='va'>pop</span>, <span class='op'>-</span><span class='va'>value</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 4 x 13
  covid month      cases_actual cnr_actual cases_pred cnr_pred
  &lt;int&gt; &lt;date&gt;            &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1     0 2020-11-01           NA        NA        152.     214.
2     1 2020-11-01          146       205.       132.     185.
3     0 2020-12-01           NA        NA        151.     211.
4     1 2020-12-01          111       156.       136.     191.
#  with 7 more variables: cases_low &lt;dbl&gt;, cases_high &lt;dbl&gt;,
#   cnr_low &lt;dbl&gt;, cnr_high &lt;dbl&gt;, cases_se &lt;dbl&gt;, cases_link &lt;dbl&gt;,
#   c_fact &lt;lgl&gt;</code></pre>
</div>
<p>Model checking</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/residuals.html'>residuals</a></span><span class='op'>(</span><span class='va'>m1_nb</span>,type<span class='op'>=</span><span class='st'>"deviance"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>all</span><span class='op'>$</span><span class='va'>month_num</span>,<span class='va'>res1</span>,ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>5</span>,<span class='fl'>10</span><span class='op'>)</span>,pch<span class='op'>=</span><span class='fl'>19</span>,cex<span class='op'>=</span><span class='fl'>0.7</span>,col<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/grDevices/gray.html'>grey</a></span><span class='op'>(</span><span class='fl'>0.6</span><span class='op'>)</span>,
     main<span class='op'>=</span><span class='st'>"Residuals over time"</span>,ylab<span class='op'>=</span><span class='st'>"Deviance residuals"</span>,xlab<span class='op'>=</span><span class='st'>"Date"</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/model_check-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Further check for autocorrelation by examining the autocorrelation and</span>
<span class='co'>#   partial autocorrelation functions</span>
<span class='fu'><a href='https://rdrr.io/r/stats/acf.html'>acf</a></span><span class='op'>(</span><span class='va'>res1</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/model_check-2.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/acf.html'>pacf</a></span><span class='op'>(</span><span class='va'>res1</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="Code_files/figure-html5/model_check-3.png" width="624" /></p>
</div>
<p>Use model to illustrate missing cases / missing CNR. Use parametric bootstrapping to get confidence intervals</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># c_fact = FALSE (from April to December) is a modelled estimate (with a CI), BUT, the model estimate and the actual observed value (i.e. 505 cases) is identical.  So going to use this as a constant, without a distribution.</span>

<span class='va'>m1_nb_covidt</span> <span class='op'>&lt;-</span> <span class='va'>m1_nb_all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='va'>covid_date_m</span><span class='op'>)</span> <span class='co'>#only interested in time period after "COVID time"</span>

<span class='co'>#NB. This is covid_no when you just return the modelled cases (on the link scale 'cases_link'); the next function replaces cases_link with a distribution with mean 'cases_link' and st. dev 'st.error' of fir</span>

<span class='va'>covid_no</span> <span class='op'>&lt;-</span> <span class='va'>m1_nb_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n_nocovid <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
      <span class='va'>cases_link</span>
      <span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>boot_fx</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span><span class='op'>{</span>
<span class='va'>covid_yes</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n_actual <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases_actual</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>covid_no</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n_nocovid <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'>pmap</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>cases_link</span>,<span class='va'>cases_se</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>mu</span>, <span class='va'>sd</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>mu</span>, <span class='va'>sd</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> 
      <span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>abs_diff</span> <span class='op'>&lt;-</span> <span class='va'>covid_no</span> <span class='op'>-</span> <span class='va'>covid_yes</span>
<span class='va'>rel_diff</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>covid_no</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>covid_no</span>

<span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>covid_yes</span>,<span class='va'>covid_no</span>,<span class='va'>abs_diff</span>,<span class='va'>rel_diff</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># run once to check</span>
<span class='fu'>boot_fx</span><span class='op'>(</span><span class='va'>m1_nb_covidt</span><span class='op'>)</span> <span class='co'># col 1 = observed cases, col 2 = predicted under counterfactual, col 3 = abs difference, col 4 = rel diff (one replicate)</span>
</code></pre>
</div>
<pre><code>[1] 1075.0000000 1421.5637648  346.5637648    0.2437905</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># now run 1000 times</span>
<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>m1_nb_covidt</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>

<span class='co'># Plot output for predicted number of cases under counterfactual no-COVID</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>x</span>, index<span class='op'>=</span><span class='fl'>2</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/unnamed-chunk-5-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sd_x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>4</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># boot command output is a vector of estimate for worst / actual / averted</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Now generate estimates with CI (using point estimate from model (cases_pred) rather than mean of boot output, although should be v. similar)</span>
<span class='va'>table_fx</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>sd</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>covid_yes</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n_actual <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases_actual</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>str<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span>
  
  <span class='va'>covid_no</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
      <span class='va'>cases_link</span>
      <span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>,
            nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>")"</span>
    <span class='op'>)</span><span class='op'>)</span>
  
  <span class='va'>abs_diff</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>n<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>
    nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span>,
    nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>")"</span>
  <span class='op'>)</span><span class='op'>)</span>
  
  <span class='va'>rel_diff</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='op'>(</span><span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>n<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>
    nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>]</span>,
    nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>sd</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>")"</span>
  <span class='op'>)</span><span class='op'>)</span>
  
  <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>covid_yes</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>abs_diff</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>rel_diff</span><span class='op'>$</span><span class='va'>str</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>as_tibble</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>covid_yes<span class='op'>=</span><span class='va'>V1</span>,
           covid_no<span class='op'>=</span><span class='va'>V2</span>,
           rel.diff <span class='op'>=</span> <span class='va'>V3</span>,
           abs.diff <span class='op'>=</span> <span class='va'>V4</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'>table_fx</span><span class='op'>(</span><span class='va'>m1_nb_covidt</span>,<span class='va'>sd_x</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/gt/man/gt.html'>gt</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ydcvnvwfsn .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ydcvnvwfsn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ydcvnvwfsn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ydcvnvwfsn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ydcvnvwfsn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ydcvnvwfsn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ydcvnvwfsn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ydcvnvwfsn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ydcvnvwfsn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ydcvnvwfsn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ydcvnvwfsn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ydcvnvwfsn .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ydcvnvwfsn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ydcvnvwfsn .gt_from_md > :first-child {
  margin-top: 0;
}

#ydcvnvwfsn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ydcvnvwfsn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ydcvnvwfsn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#ydcvnvwfsn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ydcvnvwfsn .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#ydcvnvwfsn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ydcvnvwfsn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ydcvnvwfsn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ydcvnvwfsn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ydcvnvwfsn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ydcvnvwfsn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#ydcvnvwfsn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ydcvnvwfsn .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#ydcvnvwfsn .gt_left {
  text-align: left;
}

#ydcvnvwfsn .gt_center {
  text-align: center;
}

#ydcvnvwfsn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ydcvnvwfsn .gt_font_normal {
  font-weight: normal;
}

#ydcvnvwfsn .gt_font_bold {
  font-weight: bold;
}

#ydcvnvwfsn .gt_font_italic {
  font-style: italic;
}

#ydcvnvwfsn .gt_super {
  font-size: 65%;
}

#ydcvnvwfsn .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="ydcvnvwfsn" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_yes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_no</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">rel.diff</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">abs.diff</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">1075</td>
      <td class="gt_row gt_left">1408 (1367 to 1450)</td>
      <td class="gt_row gt_left">333 (292 to 375)</td>
      <td class="gt_row gt_left">0.237 (0.214 to 0.259)</td>
    </tr>
  </tbody>
  
  
</table></div>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>mean<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>cnr_pred</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 1
   mean
  &lt;dbl&gt;
1  221.</code></pre>
</div>
<h1 id="now-to-break-this-down-by-demographics">3. Now to break this down by demographics</h1>
<p>Health centre, sex and HIV status. Cases rather than CNR, as dont have denominators for health centre or HIV status</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Impute the small number of missing variables</span>
<span class='va'>tb_data_mids</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://amices.org/mice/reference/mice.html'>mice</a></span><span class='op'>(</span>
  data<span class='op'>=</span><span class='va'>tb_data</span>,
  m<span class='op'>=</span><span class='fl'>1</span>, <span class='co'>#just one imputation as missing data v. small</span>
  method<span class='op'>=</span><span class='st'>"pmm"</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>
 iter imp variable
  1   1  sex  hiv
  2   1  sex  hiv
  3   1  sex  hiv
  4   1  sex  hiv
  5   1  sex  hiv</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tb_data_imp</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://amices.org/mice/reference/complete.mids.html'>complete</a></span><span class='op'>(</span><span class='va'>tb_data_mids</span>, action<span class='op'>=</span><span class='st'>"long"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>.imp</span>, <span class='op'>-</span><span class='va'>.id</span><span class='op'>)</span> <span class='co'>#complete data set</span>

<span class='va'>by</span> <span class='op'>&lt;-</span> <span class='va'>tb_data_imp</span> <span class='op'>%&gt;%</span>
    <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>sex</span>,<span class='va'>hiv</span>,<span class='va'>fac</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>summarise</span><span class='op'>(</span>cases<span class='op'>=</span><span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>covid <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>month</span> <span class='op'>&gt;=</span> <span class='va'>covid_date_m</span>, <span class='fl'>1L</span>,<span class='fl'>0L</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>month_num <span class='op'>=</span> <span class='fu'>cur_group_id</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>m2</span> <span class='op'>&lt;-</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/glm.nb.html'>glm.nb</a></span><span class='op'>(</span><span class='va'>cases</span> <span class='op'>~</span> <span class='va'>sex</span> <span class='op'>+</span> <span class='va'>hiv</span> <span class='op'>+</span> <span class='va'>fac</span> <span class='op'>+</span> <span class='va'>sex</span><span class='op'>:</span><span class='va'>hiv</span><span class='op'>:</span><span class='va'>fac</span> <span class='op'>+</span> <span class='va'>sex</span><span class='op'>:</span><span class='va'>hiv</span><span class='op'>:</span><span class='va'>fac</span><span class='op'>:</span><span class='va'>covid</span> <span class='op'>+</span> <span class='va'>sex</span><span class='op'>:</span><span class='va'>hiv</span><span class='op'>:</span><span class='va'>fac</span><span class='op'>:</span><span class='va'>month_num</span> <span class='op'>+</span> <span class='va'>sex</span><span class='op'>:</span><span class='va'>hiv</span><span class='op'>:</span><span class='va'>fac</span><span class='op'>:</span><span class='va'>covid</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/AsIs.html'>I</a></span><span class='op'>(</span><span class='va'>month_num</span><span class='op'>-</span><span class='va'>covid_month_num</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>by</span><span class='op'>)</span> 

<span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m2</span>, exp<span class='op'>=</span><span class='cn'>T</span>, conf.int <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/gt/man/gt.html'>gt</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#dxorwvglut .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dxorwvglut .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dxorwvglut .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dxorwvglut .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dxorwvglut .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dxorwvglut .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dxorwvglut .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#dxorwvglut .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dxorwvglut .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dxorwvglut .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dxorwvglut .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dxorwvglut .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#dxorwvglut .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dxorwvglut .gt_from_md > :first-child {
  margin-top: 0;
}

#dxorwvglut .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dxorwvglut .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dxorwvglut .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#dxorwvglut .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dxorwvglut .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#dxorwvglut .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dxorwvglut .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dxorwvglut .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dxorwvglut .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dxorwvglut .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dxorwvglut .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#dxorwvglut .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dxorwvglut .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#dxorwvglut .gt_left {
  text-align: left;
}

#dxorwvglut .gt_center {
  text-align: center;
}

#dxorwvglut .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dxorwvglut .gt_font_normal {
  font-weight: normal;
}

#dxorwvglut .gt_font_bold {
  font-weight: bold;
}

#dxorwvglut .gt_font_italic {
  font-style: italic;
}

#dxorwvglut .gt_super {
  font-size: 65%;
}

#dxorwvglut .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="dxorwvglut" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">term</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">estimate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">std.error</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">statistic</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">p.value</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">conf.low</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">conf.high</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">(Intercept)</td>
      <td class="gt_row gt_right">12.0251183</td>
      <td class="gt_row gt_right">0.193620527</td>
      <td class="gt_row gt_right">12.84470035</td>
      <td class="gt_row gt_right">9.210788e-38</td>
      <td class="gt_row gt_right">8.2030630</td>
      <td class="gt_row gt_right">17.6075891</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale</td>
      <td class="gt_row gt_right">1.4475707</td>
      <td class="gt_row gt_right">0.101476731</td>
      <td class="gt_row gt_right">3.64504029</td>
      <td class="gt_row gt_right">2.673499e-04</td>
      <td class="gt_row gt_right">1.1842292</td>
      <td class="gt_row gt_right">1.7698786</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">hivpositive</td>
      <td class="gt_row gt_right">2.3987599</td>
      <td class="gt_row gt_right">0.109916548</td>
      <td class="gt_row gt_right">7.96014716</td>
      <td class="gt_row gt_right">1.718348e-15</td>
      <td class="gt_row gt_right">1.9346071</td>
      <td class="gt_row gt_right">2.9768830</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">facqech</td>
      <td class="gt_row gt_right">1.4155812</td>
      <td class="gt_row gt_right">0.101392541</td>
      <td class="gt_row gt_right">3.42767032</td>
      <td class="gt_row gt_right">6.087843e-04</td>
      <td class="gt_row gt_right">1.1585995</td>
      <td class="gt_row gt_right">1.7299463</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:fachc</td>
      <td class="gt_row gt_right">0.9964700</td>
      <td class="gt_row gt_right">0.218406363</td>
      <td class="gt_row gt_right">-0.01619129</td>
      <td class="gt_row gt_right">9.870818e-01</td>
      <td class="gt_row gt_right">0.6478543</td>
      <td class="gt_row gt_right">1.5329785</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:fachc</td>
      <td class="gt_row gt_right">1.4668904</td>
      <td class="gt_row gt_right">0.154480679</td>
      <td class="gt_row gt_right">2.48021182</td>
      <td class="gt_row gt_right">1.313044e-02</td>
      <td class="gt_row gt_right">1.0840847</td>
      <td class="gt_row gt_right">1.9852911</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:fachc</td>
      <td class="gt_row gt_right">0.8758605</td>
      <td class="gt_row gt_right">0.151095466</td>
      <td class="gt_row gt_right">-0.87724996</td>
      <td class="gt_row gt_right">3.803509e-01</td>
      <td class="gt_row gt_right">0.6495731</td>
      <td class="gt_row gt_right">1.1807157</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:fachc</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:facqech</td>
      <td class="gt_row gt_right">0.9937354</td>
      <td class="gt_row gt_right">0.163973087</td>
      <td class="gt_row gt_right">-0.03832523</td>
      <td class="gt_row gt_right">9.694284e-01</td>
      <td class="gt_row gt_right">0.7196597</td>
      <td class="gt_row gt_right">1.3715050</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:facqech</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:facqech</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:facqech</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
      <td class="gt_row gt_right">NA</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:fachc:covid</td>
      <td class="gt_row gt_right">0.6043090</td>
      <td class="gt_row gt_right">0.265634745</td>
      <td class="gt_row gt_right">-1.89609852</td>
      <td class="gt_row gt_right">5.794702e-02</td>
      <td class="gt_row gt_right">0.3525601</td>
      <td class="gt_row gt_right">1.0080344</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:fachc:covid</td>
      <td class="gt_row gt_right">0.6119120</td>
      <td class="gt_row gt_right">0.194565356</td>
      <td class="gt_row gt_right">-2.52443085</td>
      <td class="gt_row gt_right">1.158858e-02</td>
      <td class="gt_row gt_right">0.4160417</td>
      <td class="gt_row gt_right">0.8951865</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:fachc:covid</td>
      <td class="gt_row gt_right">0.5847016</td>
      <td class="gt_row gt_right">0.249274854</td>
      <td class="gt_row gt_right">-2.15285945</td>
      <td class="gt_row gt_right">3.132973e-02</td>
      <td class="gt_row gt_right">0.3547983</td>
      <td class="gt_row gt_right">0.9418090</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:fachc:covid</td>
      <td class="gt_row gt_right">0.6664406</td>
      <td class="gt_row gt_right">0.202579137</td>
      <td class="gt_row gt_right">-2.00318868</td>
      <td class="gt_row gt_right">4.515704e-02</td>
      <td class="gt_row gt_right">0.4450009</td>
      <td class="gt_row gt_right">0.9905088</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:facqech:covid</td>
      <td class="gt_row gt_right">0.5837783</td>
      <td class="gt_row gt_right">0.303115318</td>
      <td class="gt_row gt_right">-1.77567423</td>
      <td class="gt_row gt_right">7.578663e-02</td>
      <td class="gt_row gt_right">0.3138229</td>
      <td class="gt_row gt_right">1.0394200</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:facqech:covid</td>
      <td class="gt_row gt_right">0.6524551</td>
      <td class="gt_row gt_right">0.242355882</td>
      <td class="gt_row gt_right">-1.76192558</td>
      <td class="gt_row gt_right">7.808187e-02</td>
      <td class="gt_row gt_right">0.4010068</td>
      <td class="gt_row gt_right">1.0406716</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:facqech:covid</td>
      <td class="gt_row gt_right">0.6668719</td>
      <td class="gt_row gt_right">0.198163696</td>
      <td class="gt_row gt_right">-2.04455853</td>
      <td class="gt_row gt_right">4.089840e-02</td>
      <td class="gt_row gt_right">0.4485947</td>
      <td class="gt_row gt_right">0.9848908</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:facqech:covid</td>
      <td class="gt_row gt_right">0.6828529</td>
      <td class="gt_row gt_right">0.187112347</td>
      <td class="gt_row gt_right">-2.03875309</td>
      <td class="gt_row gt_right">4.147468e-02</td>
      <td class="gt_row gt_right">0.4719652</td>
      <td class="gt_row gt_right">0.9838750</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:fachc:month_num</td>
      <td class="gt_row gt_right">1.0031503</td>
      <td class="gt_row gt_right">0.003698089</td>
      <td class="gt_row gt_right">0.85053755</td>
      <td class="gt_row gt_right">3.950263e-01</td>
      <td class="gt_row gt_right">0.9958617</td>
      <td class="gt_row gt_right">1.0105012</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:fachc:month_num</td>
      <td class="gt_row gt_right">1.0044151</td>
      <td class="gt_row gt_right">0.002910811</td>
      <td class="gt_row gt_right">1.51347173</td>
      <td class="gt_row gt_right">1.301599e-01</td>
      <td class="gt_row gt_right">0.9987862</td>
      <td class="gt_row gt_right">1.0100834</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:fachc:month_num</td>
      <td class="gt_row gt_right">0.9887630</td>
      <td class="gt_row gt_right">0.003245984</td>
      <td class="gt_row gt_right">-3.48140720</td>
      <td class="gt_row gt_right">4.987866e-04</td>
      <td class="gt_row gt_right">0.9824171</td>
      <td class="gt_row gt_right">0.9951219</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:fachc:month_num</td>
      <td class="gt_row gt_right">0.9894010</td>
      <td class="gt_row gt_right">0.002818466</td>
      <td class="gt_row gt_right">-3.78062065</td>
      <td class="gt_row gt_right">1.564379e-04</td>
      <td class="gt_row gt_right">0.9838871</td>
      <td class="gt_row gt_right">0.9949293</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:facqech:month_num</td>
      <td class="gt_row gt_right">0.9855482</td>
      <td class="gt_row gt_right">0.003808095</td>
      <td class="gt_row gt_right">-3.82270859</td>
      <td class="gt_row gt_right">1.319937e-04</td>
      <td class="gt_row gt_right">0.9781690</td>
      <td class="gt_row gt_right">0.9929322</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:facqech:month_num</td>
      <td class="gt_row gt_right">0.9874782</td>
      <td class="gt_row gt_right">0.003304027</td>
      <td class="gt_row gt_right">-3.81377534</td>
      <td class="gt_row gt_right">1.368599e-04</td>
      <td class="gt_row gt_right">0.9811326</td>
      <td class="gt_row gt_right">0.9938338</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:facqech:month_num</td>
      <td class="gt_row gt_right">0.9906002</td>
      <td class="gt_row gt_right">0.002812845</td>
      <td class="gt_row gt_right">-3.35752887</td>
      <td class="gt_row gt_right">7.864253e-04</td>
      <td class="gt_row gt_right">0.9850718</td>
      <td class="gt_row gt_right">0.9961447</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:facqech:month_num</td>
      <td class="gt_row gt_right">0.9852676</td>
      <td class="gt_row gt_right">0.002670690</td>
      <td class="gt_row gt_right">-5.55737648</td>
      <td class="gt_row gt_right">2.738596e-08</td>
      <td class="gt_row gt_right">0.9800560</td>
      <td class="gt_row gt_right">0.9904875</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:fachc:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">0.9548982</td>
      <td class="gt_row gt_right">0.054172400</td>
      <td class="gt_row gt_right">-0.85192049</td>
      <td class="gt_row gt_right">3.942582e-01</td>
      <td class="gt_row gt_right">0.8571088</td>
      <td class="gt_row gt_right">1.0625013</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:fachc:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0082146</td>
      <td class="gt_row gt_right">0.037267061</td>
      <td class="gt_row gt_right">0.21952355</td>
      <td class="gt_row gt_right">8.262422e-01</td>
      <td class="gt_row gt_right">0.9365807</td>
      <td class="gt_row gt_right">1.0855034</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:fachc:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0438382</td>
      <td class="gt_row gt_right">0.047544235</td>
      <td class="gt_row gt_right">0.90241130</td>
      <td class="gt_row gt_right">3.668384e-01</td>
      <td class="gt_row gt_right">0.9517342</td>
      <td class="gt_row gt_right">1.1457239</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:fachc:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0127307</td>
      <td class="gt_row gt_right">0.039290539</td>
      <td class="gt_row gt_right">0.32196863</td>
      <td class="gt_row gt_right">7.474765e-01</td>
      <td class="gt_row gt_right">0.9369607</td>
      <td class="gt_row gt_right">1.0946820</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivnegative:facqech:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0870723</td>
      <td class="gt_row gt_right">0.055941002</td>
      <td class="gt_row gt_right">1.49243231</td>
      <td class="gt_row gt_right">1.355859e-01</td>
      <td class="gt_row gt_right">0.9740792</td>
      <td class="gt_row gt_right">1.2158909</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivnegative:facqech:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0914497</td>
      <td class="gt_row gt_right">0.044414992</td>
      <td class="gt_row gt_right">1.97020923</td>
      <td class="gt_row gt_right">4.881440e-02</td>
      <td class="gt_row gt_right">1.0005530</td>
      <td class="gt_row gt_right">1.1922383</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexfemale:hivpositive:facqech:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0391332</td>
      <td class="gt_row gt_right">0.037616981</td>
      <td class="gt_row gt_right">1.02046858</td>
      <td class="gt_row gt_right">3.075063e-01</td>
      <td class="gt_row gt_right">0.9641577</td>
      <td class="gt_row gt_right">1.1203328</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">sexmale:hivpositive:facqech:covid:I(month_num - covid_month_num)</td>
      <td class="gt_row gt_right">1.0853049</td>
      <td class="gt_row gt_right">0.034727125</td>
      <td class="gt_row gt_right">2.35726342</td>
      <td class="gt_row gt_right">1.841018e-02</td>
      <td class="gt_row gt_right">1.0142610</td>
      <td class="gt_row gt_right">1.1620662</td>
    </tr>
  </tbody>
  
  
</table></div>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>coeffs2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m2</span>, exp<span class='op'>=</span><span class='cn'>T</span>, conf.int <span class='op'>=</span> <span class='cn'>T</span><span class='op'>)</span>
</code></pre>
</div>
</div>
Check model
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/residuals.html'>residuals</a></span><span class='op'>(</span><span class='va'>m2</span>,type<span class='op'>=</span><span class='st'>"deviance"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>by</span><span class='op'>$</span><span class='va'>month_num</span>,<span class='va'>res2</span>,ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>5</span>,<span class='fl'>10</span><span class='op'>)</span>,pch<span class='op'>=</span><span class='fl'>19</span>,cex<span class='op'>=</span><span class='fl'>0.7</span>,col<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/grDevices/gray.html'>grey</a></span><span class='op'>(</span><span class='fl'>0.6</span><span class='op'>)</span>,
     main<span class='op'>=</span><span class='st'>"Residuals over time"</span>,ylab<span class='op'>=</span><span class='st'>"Deviance residuals"</span>,xlab<span class='op'>=</span><span class='st'>"Date"</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/unnamed-chunk-8-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Further check for autocorrelation by examining the autocorrelation and</span>
<span class='co'>#   partial autocorrelation functions</span>
<span class='fu'><a href='https://rdrr.io/r/stats/acf.html'>acf</a></span><span class='op'>(</span><span class='va'>res2</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/unnamed-chunk-8-2.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/acf.html'>pacf</a></span><span class='op'>(</span><span class='va'>res2</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="Code_files/figure-html5/unnamed-chunk-8-3.png" width="624" /></p>
</div>
<p>Make predictions and plot them</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m2_by</span> <span class='op'>&lt;-</span> <span class='fu'>model2pred_by</span><span class='op'>(</span><span class='va'>by</span>,<span class='va'>m2</span><span class='op'>)</span>
<span class='va'>m2_by_continuous</span> <span class='op'>&lt;-</span> <span class='fu'>model2pred_by_continuous</span><span class='op'>(</span><span class='va'>by</span>,<span class='va'>m2</span><span class='op'>)</span>

<span class='co'># the below bit of code (and 'plot df' is a slightly hack-y way to make 'seq' correspond to real dates to be able to plot)</span>
<span class='va'>cTb</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='co'># creating a sequence of dates to match month_num (a continuous numerical value)</span>
<span class='va'>start_cTb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>cTb</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>
<span class='va'>end_cTb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>cTb</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/weekday.POSIXt.html'>months</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='co'># the end date needs to be the END of the month, not the start of the month</span>
<span class='va'>length_cTb</span> <span class='op'>&lt;-</span> <span class='va'>cTb</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>seq_cTb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.Date.html'>seq.Date</a></span><span class='op'>(</span><span class='va'>start_cTb</span>,<span class='va'>end_cTb</span>,length.out <span class='op'>=</span> <span class='va'>length_cTb</span><span class='op'>)</span> 

<span class='va'>cFb</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span>
<span class='va'>start_cFb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>cFb</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span>
<span class='va'>end_cFb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>cFb</span><span class='op'>$</span><span class='va'>month</span>, na.rm<span class='op'>=</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/weekday.POSIXt.html'>months</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>
<span class='va'>length_cFb</span> <span class='op'>&lt;-</span> <span class='va'>cFb</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>seq_cFb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.Date.html'>seq.Date</a></span><span class='op'>(</span><span class='va'>start_cFb</span>,<span class='va'>end_cFb</span>,length.out <span class='op'>=</span> <span class='va'>length_cFb</span><span class='op'>)</span> 

<span class='va'>seqb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>seq_cFb</span>, <span class='va'>seq_cTb</span><span class='op'>)</span>

<span class='va'>plot_df_by</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_continuous</span> <span class='op'>%&gt;%</span> <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>c_fact</span>,<span class='va'>month_num</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>seqb</span><span class='op'>)</span> <span class='co'># "plot df" has month_num transformed to actual date</span>


<span class='va'>label_hc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span> <span class='co'>#labels for plot</span>
  hc <span class='op'>=</span> <span class='st'>"Health Centre"</span>,
  qech <span class='op'>=</span> <span class='st'>"Queen Elizabeth Central Hospital"</span>
<span class='op'>)</span>

<span class='va'>label_hiv</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span> <span class='co'>#labels for plot</span>
  negative<span class='op'>=</span><span class='st'>"HIV Negative"</span>,
  positive<span class='op'>=</span><span class='st'>"HIV Positive"</span>
<span class='op'>)</span>

<span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cases_pred</span>,x<span class='op'>=</span><span class='va'>seqb</span>, color<span class='op'>=</span><span class='va'>sex</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>plot_df_by</span><span class='op'>%&gt;%</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_ribbon</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>ymax<span class='op'>=</span><span class='va'>cases_high</span>, ymin<span class='op'>=</span><span class='va'>cases_low</span>, x<span class='op'>=</span><span class='va'>seqb</span>, fill<span class='op'>=</span><span class='va'>sex</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span>, data<span class='op'>=</span><span class='va'>plot_df_by</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cases_actual</span>, x<span class='op'>=</span><span class='va'>month</span><span class='op'>+</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>15</span><span class='op'>)</span>, color<span class='op'>=</span><span class='va'>sex</span><span class='op'>)</span>, size<span class='op'>=</span><span class='fl'>0.5</span>, alpha<span class='op'>=</span><span class='fl'>0.7</span>, data<span class='op'>=</span><span class='va'>plot_df_by</span><span class='op'>%&gt;%</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span><span class='op'>+</span>
  <span class='fu'>geom_vline</span><span class='op'>(</span>xintercept<span class='op'>=</span><span class='va'>covid_date_m</span>, linetype<span class='op'>=</span><span class='st'>"dotted"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_fill_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#E58601"</span>,<span class='st'>"#B40F20"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_color_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#E58601"</span>,<span class='st'>"#B40F20"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Number of TB cases notified per month"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Month and Year"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>title<span class='op'>=</span><span class='st'>""</span>,
       caption<span class='op'>=</span><span class='st'>"Dots = observed number of cases \n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \n Vertical lines indicates time that COVID emergency was declared in Malawi"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_grid</span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>~</span><span class='va'>fac</span>, 
             labeller<span class='op'>=</span><span class='fu'>labeller</span><span class='op'>(</span>
               fac<span class='op'>=</span><span class='va'>label_hc</span>,
               hiv<span class='op'>=</span><span class='va'>label_hiv</span>
             <span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%+replace%</span>
    <span class='fu'>theme</span><span class='op'>(</span>legend.title <span class='op'>=</span> <span class='fu'>element_blank</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="Code_files/figure-html5/unnamed-chunk-9-1.png" width="624" /></p>
</div>
<p>Use model to make predictions by number</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Point estimate of missing</span>
<span class='va'>m2_by</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>c_fact</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases_pred</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='va'>covid_date_m</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span><span class='op'>)</span> 
</code></pre>
</div>
<pre><code># A tibble: 2 x 2
  c_fact     n
  &lt;lgl&gt;  &lt;dbl&gt;
1 FALSE  1075.
2 TRUE   1427.</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>m2_by</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>month</span>,<span class='va'>c_fact</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases_pred</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='va'>covid_date_m</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span><span class='op'>)</span> 
<span class='va'>y</span><span class='op'>[</span><span class='fl'>2</span>,<span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='va'>y</span><span class='op'>[</span><span class='fl'>1</span>,<span class='fl'>2</span><span class='op'>]</span> 
</code></pre>
</div>
<pre><code>         n
1 351.4959</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Boot-strappable function</span>
<span class='va'>m2_by_covidt</span> <span class='op'>&lt;-</span> <span class='va'>m2_by</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='va'>covid_date_m</span><span class='op'>)</span>

<span class='va'>boot_fx_by</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>var</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>var</span> <span class='op'>&lt;-</span> <span class='fu'>enquo</span><span class='op'>(</span><span class='va'>var</span><span class='op'>)</span>

  <span class='va'>covid_yes</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> 
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>group_by</span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='va'>var</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>summarise</span><span class='op'>(</span>
      n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
        <span class='va'>cases_actual</span>
      <span class='op'>)</span><span class='op'>)</span>
 
  <span class='va'>covid_no</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>group_by</span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='va'>var</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>summarise</span><span class='op'>(</span>
      n<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
        <span class='va'>cases_pred</span>
      <span class='op'>)</span><span class='op'>)</span>  
  
  <span class='va'>abs_diff</span> <span class='op'>&lt;-</span> <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>$</span><span class='va'>n</span>
  <span class='va'>rel_diff</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>$</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span>
  
  <span class='va'>covid_yes</span> <span class='op'>%&gt;%</span> <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>covid_no</span>,by<span class='op'>=</span><span class='fu'>quo_name</span><span class='op'>(</span><span class='va'>var</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>abs_diff</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>rel_diff</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>covid_yes<span class='op'>=</span><span class='va'>n.x</span>,
           covid_no<span class='op'>=</span><span class='va'>n.y</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># Run each of these once to have a look</span>
<span class='fu'>boot_fx_by</span><span class='op'>(</span><span class='va'>m2_by_covidt</span>,<span class='va'>sex</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>     sex covid_yes covid_no abs_diff  rel_diff
1 female       390 554.0506 164.0506 0.2960931
2   male       685 872.4766 187.4766 0.2148786</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>boot_fx_by</span><span class='op'>(</span><span class='va'>m2_by_covidt</span>,<span class='va'>hiv</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>       hiv covid_yes covid_no abs_diff  rel_diff
1 negative       416 603.5397 187.5397 0.3107330
2 positive       659 822.9875 163.9875 0.1992588</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>boot_fx_by</span><span class='op'>(</span><span class='va'>m2_by_covidt</span>,<span class='va'>fac</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>   fac covid_yes covid_no  abs_diff  rel_diff
1   hc       488 760.4971 272.49709 0.3583144
2 qech       587 666.0301  79.03005 0.1186584</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Annoyingly, I can't work out how to pass second variable within my function to "boot" (ie. can't add a var).</span>
<span class='co'># Go back to original boot function</span>

<span class='co'># Boot sex</span>

<span class='va'>male</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>==</span><span class='st'>"male"</span><span class='op'>)</span>
<span class='va'>female</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>sex</span><span class='op'>==</span><span class='st'>"female"</span><span class='op'>)</span>
<span class='va'>hc</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>fac</span><span class='op'>==</span><span class='st'>"hc"</span><span class='op'>)</span>
<span class='va'>qech</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>fac</span><span class='op'>==</span><span class='st'>"qech"</span><span class='op'>)</span>
<span class='va'>hivpos</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>==</span><span class='st'>"positive"</span><span class='op'>)</span>
<span class='va'>hivneg</span> <span class='op'>&lt;-</span> <span class='va'>m2_by_covidt</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>hiv</span><span class='op'>==</span><span class='st'>"negative"</span><span class='op'>)</span>



<span class='co'># Then boot each one</span>
<span class='va'>male_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>male</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>female_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>female</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>hc_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>hc</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>qech_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>qech</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>hivpos_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>hivpos</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>hivneg_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>hivneg</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>1000</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>all_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>m2_by_covidt</span>, <span class='va'>boot_fx</span>, R<span class='op'>=</span><span class='fl'>1000</span>, sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>

<span class='co'>#Get st. dev</span>
<span class='va'>boot_sd</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>var</span><span class='op'>)</span><span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>var</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>var</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>var</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>var</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>4</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>sd_male</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>male_res</span><span class='op'>)</span>
<span class='va'>sd_female</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>female_res</span><span class='op'>)</span>
<span class='va'>sd_hc</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>hc_res</span><span class='op'>)</span>
<span class='va'>sd_qech</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>qech_res</span><span class='op'>)</span>
<span class='va'>sd_hivpos</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>hivpos_res</span><span class='op'>)</span>
<span class='va'>sd_hivneg</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>hivneg_res</span><span class='op'>)</span>
<span class='va'>sd_all</span> <span class='op'>&lt;-</span> <span class='fu'>boot_sd</span><span class='op'>(</span><span class='va'>all_res</span><span class='op'>)</span>

<span class='va'>table_fx_2</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,<span class='va'>df_sd</span><span class='op'>)</span><span class='op'>{</span> <span class='co'>#not using boot function results, as get the point estimate direct from model; but using boot st. devs</span>
  <span class='va'>covid_yes</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n_actual <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>cases_actual</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>str<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span>
  
  <span class='va'>covid_no</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>summarise</span><span class='op'>(</span>n <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span>
      <span class='va'>cases_link</span>
      <span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>,
            nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>")"</span>
    <span class='op'>)</span><span class='op'>)</span>
  
  <span class='va'>abs_diff</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>n<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>
    nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span>,
    nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>0</span><span class='op'>)</span>,<span class='st'>")"</span>
  <span class='op'>)</span><span class='op'>)</span>
  
  <span class='va'>rel_diff</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='op'>(</span><span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span> <span class='op'>-</span> <span class='va'>covid_yes</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>n</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>n<span class='op'>=</span><span class='va'>n_actual</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>
    nhi <span class='op'>=</span> <span class='va'>n</span> <span class='op'>+</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>]</span>,
    nlo <span class='op'>=</span> <span class='va'>n</span> <span class='op'>-</span> <span class='fl'>1.96</span><span class='op'>*</span><span class='va'>df_sd</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>str <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>n</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>" ("</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nlo</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>" to "</span>,<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nhi</span>,digits<span class='op'>=</span><span class='fl'>3</span><span class='op'>)</span>,<span class='st'>")"</span>
  <span class='op'>)</span><span class='op'>)</span>
  
  <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>covid_yes</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>covid_no</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>abs_diff</span><span class='op'>$</span><span class='va'>str</span>, <span class='va'>rel_diff</span><span class='op'>$</span><span class='va'>str</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>as_tibble</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>rename</span><span class='op'>(</span>covid_yes<span class='op'>=</span><span class='va'>V1</span>,
           covid_no<span class='op'>=</span><span class='va'>V2</span>,
           abs.diff <span class='op'>=</span> <span class='va'>V3</span>,
          rel.diff <span class='op'>=</span> <span class='va'>V4</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>male</span>,<span class='va'>sd_male</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>bind_rows</span><span class='op'>(</span><span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>female</span>,<span class='va'>sd_female</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>bind_rows</span><span class='op'>(</span><span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>hc</span>,<span class='va'>sd_hc</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>bind_rows</span><span class='op'>(</span><span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>qech</span>,<span class='va'>sd_qech</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>bind_rows</span><span class='op'>(</span><span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>hivpos</span>,<span class='va'>sd_hivpos</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>bind_rows</span><span class='op'>(</span><span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>hivneg</span>,<span class='va'>sd_hivneg</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://amices.org/mice/reference/cbind.html'>cbind</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"male"</span>,<span class='st'>"female"</span>,<span class='st'>"hc"</span>,<span class='st'>"qech"</span>,<span class='st'>"hivpos"</span>,<span class='st'>"hivneg"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>group <span class='op'>=</span> <span class='va'>`c(\"male\", \"female\", \"hc\", \"qech\", \"hivpos\", \"hivneg\")`</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/lm.ridge.html'>select</a></span><span class='op'>(</span><span class='va'>group</span>,<span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/pkg/gt/man/gt.html'>gt</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#vrajwdlodw .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vrajwdlodw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vrajwdlodw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vrajwdlodw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vrajwdlodw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vrajwdlodw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vrajwdlodw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vrajwdlodw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vrajwdlodw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vrajwdlodw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vrajwdlodw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vrajwdlodw .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#vrajwdlodw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vrajwdlodw .gt_from_md > :first-child {
  margin-top: 0;
}

#vrajwdlodw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vrajwdlodw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vrajwdlodw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#vrajwdlodw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vrajwdlodw .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#vrajwdlodw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vrajwdlodw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vrajwdlodw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vrajwdlodw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vrajwdlodw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vrajwdlodw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#vrajwdlodw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vrajwdlodw .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#vrajwdlodw .gt_left {
  text-align: left;
}

#vrajwdlodw .gt_center {
  text-align: center;
}

#vrajwdlodw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vrajwdlodw .gt_font_normal {
  font-weight: normal;
}

#vrajwdlodw .gt_font_bold {
  font-weight: bold;
}

#vrajwdlodw .gt_font_italic {
  font-style: italic;
}

#vrajwdlodw .gt_super {
  font-size: 65%;
}

#vrajwdlodw .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="vrajwdlodw" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">group</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_yes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_no</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">abs.diff</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">rel.diff</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">male</td>
      <td class="gt_row gt_left">685</td>
      <td class="gt_row gt_left">872 (846 to 899)</td>
      <td class="gt_row gt_left">187 (161 to 214)</td>
      <td class="gt_row gt_left">0.215 (0.191 to 0.238)</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">female</td>
      <td class="gt_row gt_left">390</td>
      <td class="gt_row gt_left">554 (534 to 574)</td>
      <td class="gt_row gt_left">164 (144 to 184)</td>
      <td class="gt_row gt_left">0.296 (0.271 to 0.321)</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">hc</td>
      <td class="gt_row gt_left">488</td>
      <td class="gt_row gt_left">760 (736 to 785)</td>
      <td class="gt_row gt_left">272 (248 to 297)</td>
      <td class="gt_row gt_left">0.358 (0.338 to 0.379)</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">qech</td>
      <td class="gt_row gt_left">587</td>
      <td class="gt_row gt_left">666 (644 to 688)</td>
      <td class="gt_row gt_left">79 (57 to 101)</td>
      <td class="gt_row gt_left">0.119 (0.09 to 0.148)</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">hivpos</td>
      <td class="gt_row gt_left">659</td>
      <td class="gt_row gt_left">823 (798 to 848)</td>
      <td class="gt_row gt_left">164 (139 to 189)</td>
      <td class="gt_row gt_left">0.199 (0.175 to 0.223)</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">hivneg</td>
      <td class="gt_row gt_left">416</td>
      <td class="gt_row gt_left">604 (582 to 626)</td>
      <td class="gt_row gt_left">188 (166 to 210)</td>
      <td class="gt_row gt_left">0.311 (0.286 to 0.336)</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Table for everyone</span>
<span class='fu'>table_fx_2</span><span class='op'>(</span><span class='va'>m2_by_covidt</span>,<span class='va'>sd_all</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/pkg/gt/man/gt.html'>gt</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#zoaamwpxfq .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zoaamwpxfq .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zoaamwpxfq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zoaamwpxfq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zoaamwpxfq .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zoaamwpxfq .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zoaamwpxfq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zoaamwpxfq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zoaamwpxfq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zoaamwpxfq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zoaamwpxfq .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zoaamwpxfq .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#zoaamwpxfq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zoaamwpxfq .gt_from_md > :first-child {
  margin-top: 0;
}

#zoaamwpxfq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zoaamwpxfq .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zoaamwpxfq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#zoaamwpxfq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zoaamwpxfq .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#zoaamwpxfq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zoaamwpxfq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zoaamwpxfq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zoaamwpxfq .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zoaamwpxfq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zoaamwpxfq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#zoaamwpxfq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zoaamwpxfq .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#zoaamwpxfq .gt_left {
  text-align: left;
}

#zoaamwpxfq .gt_center {
  text-align: center;
}

#zoaamwpxfq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zoaamwpxfq .gt_font_normal {
  font-weight: normal;
}

#zoaamwpxfq .gt_font_bold {
  font-weight: bold;
}

#zoaamwpxfq .gt_font_italic {
  font-style: italic;
}

#zoaamwpxfq .gt_super {
  font-size: 65%;
}

#zoaamwpxfq .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="zoaamwpxfq" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_yes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">covid_no</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">abs.diff</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">rel.diff</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">1075</td>
      <td class="gt_row gt_left">1427 (1394 to 1459)</td>
      <td class="gt_row gt_left">352 (319 to 384)</td>
      <td class="gt_row gt_left">0.246 (0.229 to 0.264)</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
Sensitivity analysis
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Harmonics for seasons</span>
<span class='va'>sens1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/glm.nb.html'>glm.nb</a></span><span class='op'>(</span><span class='va'>cases</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>covid</span><span class='op'>*</span><span class='va'>month_num</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/tsModel/man/modelTerms.html'>harmonic</a></span><span class='op'>(</span><span class='va'>month_num</span>,<span class='fl'>2</span>,<span class='fl'>12</span><span class='op'>)</span>, <span class='va'>all</span><span class='op'>)</span>  <span class='co'># have to use month_num here as I can't get 'harmonic' to work sensibly with dates</span>

<span class='va'>s1_all</span> <span class='op'>&lt;-</span> <span class='fu'>model2pred_pop</span><span class='op'>(</span><span class='va'>all</span>,<span class='va'>sens1</span><span class='op'>)</span>

<span class='va'>plot_all_fx</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span><span class='op'>{</span>
<span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_rect</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xmin<span class='op'>=</span><span class='va'>covid_date_m</span>, xmax<span class='op'>=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"15 Dec 2020"</span><span class='op'>)</span>, ymin<span class='op'>=</span><span class='op'>-</span><span class='cn'>Inf</span>, ymax<span class='op'>=</span><span class='cn'>Inf</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.1</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_pred</span>, x<span class='op'>=</span><span class='va'>month</span>, linetype<span class='op'>=</span><span class='st'>"observed"</span>, color<span class='op'>=</span><span class='st'>"observed"</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_ribbon</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>ymax<span class='op'>=</span><span class='va'>cnr_high</span>, ymin<span class='op'>=</span><span class='va'>cnr_low</span>, x<span class='op'>=</span><span class='va'>month</span>, fill<span class='op'>=</span><span class='st'>"observed"</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span>, data<span class='op'>=</span><span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>F</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_pred</span>, x<span class='op'>=</span><span class='va'>month</span>, linetype<span class='op'>=</span><span class='st'>"counterfactual"</span>, color<span class='op'>=</span><span class='st'>"counterfactual"</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
<span class='fu'>geom_ribbon</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>ymax<span class='op'>=</span><span class='va'>cnr_high</span>, ymin<span class='op'>=</span><span class='va'>cnr_low</span>, x<span class='op'>=</span><span class='va'>month</span>, fill<span class='op'>=</span><span class='st'>"counterfactual"</span><span class='op'>)</span>, alpha<span class='op'>=</span><span class='fl'>0.3</span>, data<span class='op'>=</span><span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>c_fact</span><span class='op'>==</span><span class='cn'>T</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y<span class='op'>=</span><span class='va'>cnr_actual</span>, x<span class='op'>=</span><span class='va'>month</span><span class='op'>+</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/period.html'>days</a></span><span class='op'>(</span><span class='fl'>15</span><span class='op'>)</span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>plot_df</span>, shape<span class='op'>=</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> <span class='co'># plot actual numbers on 15th each month</span>
  <span class='co'>#geom_vline(aes(xintercept=covid_date_m)) +</span>
  <span class='fu'>scale_linetype_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>,values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"dashed"</span>,<span class='st'>"solid"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_fill_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#DE3163"</span>,<span class='st'>"#3FE0D0"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_color_manual</span><span class='op'>(</span>name<span class='op'>=</span><span class='st'>"legend"</span>, values<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"#DE3163"</span>,<span class='st'>"#4286f4"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ylab</span><span class='op'>(</span><span class='st'>"Case Notification Rate (per 100,000 person-years)"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>xlab</span><span class='op'>(</span><span class='st'>"Month and Year"</span><span class='op'>)</span> <span class='op'>+</span>
   <span class='fu'>labs</span><span class='op'>(</span>title<span class='op'>=</span><span class='st'>"Blantyre TB Case Notifcation Rate"</span>,
       caption<span class='op'>=</span><span class='st'>"CNR = Cases TB notified per 100,000 person-years, \n Dots = observed case notification rate \n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \n Shaded area indicates time that COVID emergency was declared in Malawi"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>coord_cartesian</span><span class='op'>(</span>xlim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 April 2016"</span><span class='op'>)</span>, <span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"15 Dec 2020"</span><span class='op'>)</span><span class='op'>)</span>,ylim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>430</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_x_date</span><span class='op'>(</span>expand <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span>  <span class='op'>%+replace%</span>
    <span class='fu'>theme</span><span class='op'>(</span>legend.title <span class='op'>=</span> <span class='fu'>element_blank</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>


<span class='fu'>plot_all_fx</span><span class='op'>(</span><span class='va'>s1_all</span><span class='op'>)</span>
</code></pre>
</div>
<img src="Code_files/figure-html5/unnamed-chunk-13-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>s1_covidt</span> <span class='op'>&lt;-</span> <span class='va'>s1_all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='va'>covid_date_m</span><span class='op'>)</span> 
<span class='fu'>boot_fx</span><span class='op'>(</span><span class='va'>s1_covidt</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 1075.0000000 1420.7231679  345.7231679    0.2433431</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>est_s1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/boot/man/boot.html'>boot</a></span><span class='op'>(</span><span class='va'>s1_covidt</span>,<span class='va'>boot_fx</span>,R<span class='op'>=</span><span class='fl'>100</span>,sim<span class='op'>=</span><span class='st'>"parametric"</span><span class='op'>)</span>
<span class='va'>sd_s1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>est_s1</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>est_s1</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>est_s1</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span>,<span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>est_s1</span><span class='op'>$</span><span class='va'>t</span><span class='op'>[</span>,<span class='fl'>4</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># boot command output is a vector of estimate for worst / actual / averted</span>

<span class='fu'>table_fx</span><span class='op'>(</span><span class='va'>s1_covidt</span>,<span class='va'>sd_s1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 4
  covid_yes covid_no            rel.diff         abs.diff             
  &lt;chr&gt;     &lt;chr&gt;               &lt;chr&gt;            &lt;chr&gt;                
1 1075      1387 (1330 to 1443) 312 (255 to 368) 0.225 (0.193 to 0.25</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>table_fx</span><span class='op'>(</span><span class='va'>m1_nb_covidt</span>,<span class='va'>sd_x</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 4
  covid_yes covid_no            rel.diff         abs.diff             
  &lt;chr&gt;     &lt;chr&gt;               &lt;chr&gt;            &lt;chr&gt;                
1 1075      1408 (1367 to 1450) 333 (292 to 375) 0.237 (0.214 to 0.25</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>m1_nb</span><span class='op'>$</span><span class='va'>aic</span>
</code></pre>
</div>
<pre><code>[1] 519.1786</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sens1</span><span class='op'>$</span><span class='va'>aic</span> <span class='co'>#actually a little higher, no serious difference</span>
</code></pre>
</div>
<pre><code>[1] 523.2373</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fl'>333</span><span class='op'>/</span> <span class='va'>all</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>&gt;=</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>dmy</a></span><span class='op'>(</span><span class='st'>"01 April 2020"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>summarise</span><span class='op'>(</span>m<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/stats/median.html'>median</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span><span class='fl'>100000</span>
</code></pre>
</div>
<pre><code>         m
1 39.16637</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
