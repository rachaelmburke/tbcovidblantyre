{
  "articles": [
    {
      "path": "about.html",
      "title": "About this site",
      "author": [],
      "contents": "\nThis is a website (and github repository) of data and code for our work about impact of COVID on TB notifications in Blantyre Malawi.\nWe are the Malawi Liverpool Wellcome Population Health group; a group of reseachers affiliated with Malawi-Liverpool-Wellcome, Liverpool School of Tropical Medicine, London School of Hygiene and Tropical Medicine, College of Medicine at University of Malawi and University of Sheffield.\nThe TB electronic reporting system is a partnership between our group and Malawi National TB programme and Blantyre District Health Office.\nSome more information about our research group is available at Dr Peter MacPherson’s group manual here https://petermacp.github.io/mlw.public.health.group/ .\nMore data about TB epidemiology in Blantyre is here https://github.com/petermacp/BlantyreTBEpi (a companion package to the paper ‘MacPherson, P. et al. Disparities in access to diagnosis and care in Blantyre, Malawi, identified through enhanced tuberculosis surveillance and spatial analysis. BMC Medicine 17, 21 (2019). https://doi.org/10.1186/s12916-019-1260-6’ )\nIf you have any questions, we’d be very happy to discuss. A good first port of call is probably peter.macpherson [at] lstmed [dot] ac [dot] uk or rachael.burke [at] lshtm [dot] ac [dot] uk.\n\n\n\n",
      "last_modified": "2021-04-19T22:17:07+02:00"
    },
    {
      "path": "Appendix.html",
      "title": "Appendix",
      "description": "Code for our Interrupted Time Series Analysis\n",
      "author": [],
      "date": "`r Sys.Date()`",
      "contents": "\nWhat is the significance of chosen inflection point?\n\n\nlibrary(MASS)\nlibrary(here)\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(zoo)\n\ntb_data_group <- read_csv(here(\"data\",\"tb_data_group.csv\"))\ncovid_date_m <- dmy(\"01 April 2020\") # date of COVID starting (whole month)\ncovid_month_num <- 47\n\nload(here(\"data/Pop_Age_Sex_HIV.rdata\")) # Blantyre census data disaggregated by age and sex (from world population prospects and modified by CCK)\ncens <- PopQ %>%\n  mutate(year_q=paste0(Year,\":\",Q)) %>%\n  mutate(yq=yq(year_q)) # yq is a date with 1st day of each quarter\n\nage_levels_10 <- c(\"0-14\",\"15-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\")\n\ntb_data <- tb_data_group %>% uncount(n) %>% mutate(month=dmy(month)) %>% mutate(fac=factor(fac),\n                                                                                sex = factor(sex),\n                                                                                hiv = factor(hiv))\n\ncens_10yr <- cens %>% mutate(age_gp=case_when(\n  Age==\"[0,4)\" ~ \"0-14\",\n  Age==\"[5,9)\" ~ \"0-14\",\n  Age==\"[10,14)\" ~ \"0-14\",\n  Age==\"[15,19)\" ~ \"15-24\",\n  Age==\"[20,24)\" ~ \"15-24\",\n  Age==\"[25,29)\" ~ \"25-34\",\n  Age==\"[30,34)\" ~ \"25-34\",\n  Age==\"[35,39)\" ~ \"35-44\",\n  Age==\"[40,44)\" ~ \"35-44\",\n  Age==\"[45,49)\" ~ \"45-54\",\n  Age==\"[50,54)\" ~ \"45-54\",\n  Age==\"[55,59)\" ~ \"55-64\",\n  Age==\"[60,64)\" ~ \"55-64\",\n  Age==\"[60,64)\" ~ \"55-64\",\n  Age==\"[65,69)\" ~ \"65+\",\n  Age==\"[70,74)\" ~ \"65+\",\n  Age==\"[75, )\" ~ \"65+\"\n)) %>%\n  group_by(yq, age_gp, Sex) %>%\n  summarise(pop=sum(Population))\n\ncens_all <- cens %>%\n  group_by(yq) %>%\n  summarise(pop=sum(Population)) %>%\n  mutate(`0`=pop,  # so this is a slightly hacky way to get population demoninators for each month (the quarter denominator gets repeated the same three times, not ideal, but it doesn't make any difference.  For plotting the graph - where CNR is a continous variable, I interpolate population to avoid zigzags)\n         `1`=pop,\n         `2`=pop) %>%\n  pivot_longer(c(`0`,`1`,`2`),names_to=\"m\") %>%\n  mutate(m=as.numeric(m)) %>%\n  mutate(month=yq+months(m))\n\n# then this is dataframe lumping all cases togehter\nall <- tb_data %>% \n  group_by(month) %>%\n  summarise(cases=n()) %>% #generates cases per month\n  ungroup() %>%\n  mutate(covid = if_else(month >= covid_date_m, 1L,0L)) %>%\n  arrange(month) %>%\n  mutate(month_num = 1:n()) %>% #create a month_num variable to use in model (rather than actual date, so coefficients make sense)\n  left_join(cens_all) %>%\n  mutate(cnr=(cases/pop)*100000*12) # x12 to get annualised CNRs (NB. children included in both denominator and numerator here)\n\n\n\n\n\nm <-glm.nb(cases ~ month_num + offset(log(pop)), data=all) # model without specifying COVID time\nres <- residuals(m)\n\n\nres_df <- res %>% as_tibble_col(column_name=\"res\") %>% cbind(all$month_num) %>% rename(month_num=`all$month_num`) \nres_df <- res_df %>% mutate(movingav=zoo::rollmean(res,k=5, na.pad=T, align=\"left\"))\n\nggplot(res_df) +\n  geom_point(aes(x=month_num, y=res),shape=1) + \n  geom_line(aes(x=month_num, y=movingav)) +\n  geom_vline(aes(xintercept=covid_month_num), color=\"blue\") + # add a line at covid_month_num\n  geom_hline(aes(yintercept=0), color=\"darkgrey\") + # add a zero line\n  labs(title=\"Residuals from model\",\n         caption=\"Blue line = start of COVID \\n Grey line = zero reference line \\n Black line = rolling sum of residuals for nine months starting at plotted month\") +\n  ylab(\"Residuals\") +\n  xlab(\"Months since June 2016\") +\n  theme_bw()\n\n\n\n\n\n\n## last 9 are 'covid'\nressum <- sum(rev(res)[1:9]) #test statistic: sum of residuals\n\nN <- 1e6 #number of perms: I tried up to 1e6 (bit slow, but stable P)\npermute.vec <- function(X) X[sample(length(X),replace = FALSE)]\n## permute.vec <- function(X) X #for testing\npermute.vec(res) #test\n\n\n          53           44           18           45           30 \n 0.296485714  2.057099211  0.447358892  0.714035154 -0.659526588 \n          17           36            8           33           32 \n-0.600903283 -0.096255482  0.010083410  1.263587570 -0.868022538 \n          28           43           34           47           25 \n 1.038083155  0.456478153  0.999874178 -1.768416420  0.683105486 \n           6           13            7           11           38 \n 0.464648766 -0.350220488 -0.046408481 -1.055558924  1.884665153 \n           4           12           15           49           55 \n-0.717101405  0.027924020  0.756811030 -1.111760550 -0.979214352 \n          19           31            5           22           24 \n-0.884675966 -0.874028706 -0.260904523  0.115737346  1.424002604 \n           2           26           37           46           23 \n-1.617560992  0.658967896  0.617934234  0.845505178 -0.374750290 \n          20           40            1            3           21 \n 0.602567186 -1.119096154 -0.818146182 -0.187565884 -0.008955361 \n          48           50           42           41           14 \n-2.150209970 -1.408940975 -0.147192969 -2.791492635 -1.112986129 \n          29           27            9           54           51 \n 0.273721355  1.247464391  0.455950858  0.559682350 -1.579115609 \n          39           35           10           52           16 \n 1.456342275  0.145075331  0.088058979  0.117361206  1.183886648 \n\nresmat <- matrix(res,nrow=N,ncol=length(res),byrow = TRUE)\nresmat <- apply(resmat,1,permute.vec)\nresmat <- t(resmat) #each row a permutation of resds\nlast9 <- length(res) - 1:9 + 1 #indices of last 9 columns\nresmat <- resmat[,last9]       #restrict to last 9 columns\nres.dist <- rowSums(resmat) #distribution of statistic for perms\nlength(res.dist)\n\n\n[1] 1000000\n\nhist(res.dist)\n\n\n\nsummary(res.dist)\n\n\n    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n-13.1095  -2.3350  -0.3969  -0.4416   1.4922  10.5439 \n\nmean(res.dist<ressum) #P value~0.004 (what quantile is obs'd test stat?)\n\n\n[1] 0.003678\n\n## re-run a few times to ensure accurate as quoted\n\n## now consider other windows of length 9 when a drop may have happened:\nressums <- list() #window locations 1 to just shy of last 9\nfor(i in 1:(1+length(res)-2*9))\n    ressums[[i]] <- sum(res[seq(from=i,length.out = 9)])\nPvals <- lapply(ressums,function(x) mean(res.dist<x)) #as above: quantile\nPvals <- unlist(Pvals)\nPvals\n\n\n [1] 0.209867 0.310922 0.382698 0.411663 0.462460 0.347372 0.385640\n [8] 0.556247 0.470577 0.469405 0.338378 0.565622 0.560344 0.625389\n[15] 0.719920 0.795044 0.739842 0.864833 0.919005 0.984102 0.977974\n[22] 0.960608 0.916414 0.884439 0.872608 0.895410 0.856907 0.718173\n[29] 0.665456 0.843859 0.964462 0.956427 0.839226 0.684414 0.612740\n[36] 0.835369 0.898664 0.912789\n\nall(Pvals>0.05) #TRUE - no others are significant\n\n\n[1] TRUE\n\n\n\n\n",
      "last_modified": "2021-04-19T22:17:26+02:00"
    },
    {
      "path": "Code.html",
      "title": "Code",
      "description": "Code for our Interrupted Time Series Analysis\n",
      "author": [],
      "date": "`r Sys.Date()`",
      "contents": "\n1. Load packages and data\n\n\n# Packages\nlibrary(MASS, exclude=\"select\") # for glm.nb\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(lubridate)\nlibrary(broom)\nlibrary(here)\nlibrary(gt) # make tables loook nice\nlibrary(stringr)\nlibrary(tsModel) #for including harmonic fx for seasonality\nlibrary(boot)\nlibrary(mice)\nlibrary(janitor) #for tabyl\nlibrary(zoo) #for na.approx (interpolate values of population when month treated continuously)\n\n# Load the data\n\ntb_data_group <- read_csv(here(\"data\",\"tb_data_group.csv\"))\n\nload(here(\"data/Pop_Age_Sex_HIV.rdata\")) # Blantyre census data disaggregated by age and sex (from world population prospects and modified by CCK)\ncens <- PopQ %>%\n  mutate(year_q=paste0(Year,\":\",Q)) %>%\n  mutate(yq=yq(year_q)) # yq is a date with 1st day of each quarter\n\nage_levels_10 <- c(\"0-14\",\"15-24\", \"25-34\", \"35-44\", \"45-54\", \"55-64\", \"65+\")\ncovid_date_m <- dmy(\"01 Apr 2020\") # date of COVID starting (whole month)\n\n\n\nDefine some functions for use later\n\n\n# These functions takes a model and makes predictions and puts them into a dataframe (including counterfactual no-COVID)\n\n# The first functions give a df containing one observation per month and predictions for all the levels contained in data plus a counterfactual \"no COVID\" time.  This is used for calculating expected cumlative numbers of TB cases / CNR (particularly in counterfactual months).\n\n# In second function month is not integer-coded but is continuous -- this is for plotting the graphs so that there is an instaneous effect of COVID (with integer-coded months the drop between March and April was a diagonal line on the graph connecting March and April 2020, which didn't make sense as we'd modelled an instaneneous drop)\n\nmodel2pred_pop <- function(df,m){ #incorporating a population term to give CNRs\n\nscaffold_df <- all %>% \n  select(month_num,covid) %>% \n  tidyr::expand(month_num,covid) %>% #makes predictions over every level that exists in the data\n  left_join(all%>%select(month,month_num,pop))\n\npred_obj <- predict(m, type=\"link\", newdata=scaffold_df, se.fit=T)\n\ndf1 <- scaffold_df %>%\n  left_join(all) %>%\n  rename(cases_actual=cases) %>%\n  rename(cnr_actual=cnr) %>%\n  mutate(cases_pred=(exp(pred_obj$fit))) %>%\n  mutate(cnr_pred=exp(\n    pred_obj$fit - log(pop)\n  ) * 100000 * 12) %>%\n  mutate(cases_low=(exp(pred_obj$fit - 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_high=(exp(pred_obj$fit + 1.96*pred_obj$se.fit))) %>%\n  mutate(cnr_low=exp(\n    (pred_obj$fit - 1.96*pred_obj$se.fit) - log(pop)\n    )\n    *100000 * 12 ) %>%\n  mutate(cnr_high=exp(\n    (pred_obj$fit + 1.96*pred_obj$se.fit) - log(pop)\n    ) *100000 * 12) %>%\n  mutate(cases_se=pred_obj$se.fit) %>%\n  mutate(cases_link=pred_obj$fit) #need to have this on link scale to bootstrap later\n\ndf2 <- df1 %>%\n  mutate(irrelevant=case_when(\n    covid==1 & month_num < covid_month_num ~ T,\n    TRUE ~ F\n  )) %>%\n  filter(irrelevant!=T) %>%  #get rid of \"COVID\"=yes when time is before COVID (irrelevant predictions)\n  select(-irrelevant) %>%\n  mutate(c_fact=case_when(\n        covid==0 & month_num >= covid_month_num ~ T, #create a variable to indicate no-COVID by after COVID-time is counterfactual\n        T ~ F\n  ))\ndf2\n}\n\nmodel2pred_pop_continuous <- function(df,m){ #incorporating a population term to give CNRs\n\nseq <- seq(0,1, length=100) %>% tibble() # creates 100 data point between start and end month numbers (i.e. \"month num\" becomes nearly continuous)\n\nexpand_months <- all %>% \n  dplyr::select(month_num,covid) %>% \n  tidyr::expand(month_num,covid, seq$.) %>% # now includes 1000 extra points for each level of covid and month_num\n  mutate(month_num=`seq$.` + month_num) %>% # makes a 'continous' variable for month_num (have to keep name month_num so that plotting works as that's the variable name in model)\n  select(-`seq$.`)\n\nx <- all %>% select(month_num, month) # I need this to get actual months back, not just month_num\n\nexpand_pop <- expand_months %>% \n  left_join(all, by=c(\"month_num\")) %>%\n  select(month_num,covid.x, pop) %>%\n  rename(covid=covid.x)%>%\n  na.approx() %>% # from zoo package, linear interpolation of population between quarters (to match months now being effectively continuous)\n  na.locf() %>% \n  as.data.frame() %>%\n  left_join(x)\n\nscaffold_df_continuous <- expand_pop\n\npred_obj <- predict(m, type=\"link\", newdata=scaffold_df_continuous, se.fit=T)\n\ndf1 <- scaffold_df_continuous %>%\n  left_join(all) %>% # this brings calendar month back but only when COVID=\n  rename(cases_actual=cases) %>%\n  rename(cnr_actual=cnr) %>%\n  mutate(cases_pred=(exp(pred_obj$fit))) %>%\n  mutate(cnr_pred=exp(\n    pred_obj$fit - log(pop)\n  ) * 100000 * 12) %>%\n  mutate(cases_low=(exp(pred_obj$fit - 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_high=(exp(pred_obj$fit + 1.96*pred_obj$se.fit))) %>%\n  mutate(cnr_low=exp(\n    (pred_obj$fit - 1.96*pred_obj$se.fit) - log(pop)\n    )\n    *100000 * 12 ) %>%\n  mutate(cnr_high=exp(\n    (pred_obj$fit + 1.96*pred_obj$se.fit) - log(pop)\n    ) *100000 * 12) %>%\n  mutate(cases_se=pred_obj$se.fit) %>%\n  mutate(cases_link=pred_obj$fit) #need to have this on link scale to bootstrap later\n\ndf2 <- df1 %>%\n  mutate(irrelevant=case_when(\n    covid==1 & month_num < covid_month_num ~ T,\n    TRUE ~ F\n  )) %>%\n  filter(irrelevant!=T) %>%  #get rid of \"COVID\"=yes when time is before COVID (irrelevant predictions)\n  select(-irrelevant) %>%\n  mutate(c_fact=case_when(\n        covid==0 & month_num >= covid_month_num ~ T, #create a variable to indicate no-COVID by after COVID-time is counterfactual\n        T ~ F\n  ))\ndf2\n}\n\n\nmodel2pred_by <- function(df,m){ \n\nscaffold_df <- df %>% \n  dplyr::filter(hiv!=\"unknown\") %>% \n  dplyr::filter(is.na(sex)==F) %>%\n  select(month_num,covid,fac,hiv,sex) %>% \n  tidyr::expand(month_num,covid,fac,hiv,sex) %>% #makes predictions over every level\n  left_join(by%>%select(month,month_num)%>%distinct())\n\npred_obj <- predict(m, type=\"link\", newdata=scaffold_df, se.fit=T)\n\ndf1 <- scaffold_df %>%\n  left_join(df) %>%\n  rename(cases_actual=cases) %>%\n  mutate(cases_pred=(exp(pred_obj$fit))) %>%\n  mutate(cases_low=(exp(pred_obj$fit - 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_high=(exp(pred_obj$fit + 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_se=pred_obj$se.fit) %>%\n  mutate(cases_link=pred_obj$fit) #need to have this on link scale to bootstrap later\n\ndf2 <- df1 %>%\n  mutate(irrelevant=case_when(\n    covid==1 & month_num < covid_month_num ~ T,\n    TRUE ~ F\n  )) %>%\n  filter(irrelevant!=T) %>%  #get rid of \"COVID\"=yes when time is before COVID (irrelevant predictions)\n  select(-irrelevant) %>%\n  mutate(c_fact=case_when(\n        covid==0 & month_num >= covid_month_num ~ T, \n        T ~ F))\ndf2\n}\n\nmodel2pred_by_continuous <- function(df,m){ \n\n  seq <- seq(0,1, length=100) %>% tibble() # creates 100 data point between start and end month numbers (i.e. \"month num\" becomes nearly continuous)\n\n  expand_months <- df %>% \n  dplyr::select(month_num,covid) %>% \n  tidyr::expand(month_num,covid, seq$.) %>% # now includes 1000 extra points for each level of covid and month_num\n  mutate(month_num=`seq$.` + month_num) %>% # makes a 'continous' variable for month_num (have to keep name month_num so that plotting works as that's the variable name in model)\n  select(-`seq$.`)\n  \n  x <- df %>%\n  dplyr::filter(hiv!=\"unknown\") %>% \n  dplyr::filter(is.na(sex)==F) \n  \n  scaffold_df <- expand_months %>% left_join(x) %>%\n  select(month_num,covid,fac,hiv,sex) %>% \n  tidyr::expand(month_num,covid,fac,hiv,sex) %>% #makes predictions over every level\n  left_join(by%>%select(month,month_num)%>%distinct())\n\npred_obj <- predict(m, type=\"link\", newdata=scaffold_df, se.fit=T)\n\ndf1 <- scaffold_df %>%\n  left_join(df) %>%\n  rename(cases_actual=cases) %>%\n  mutate(cases_pred=(exp(pred_obj$fit))) %>%\n  mutate(cases_low=(exp(pred_obj$fit - 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_high=(exp(pred_obj$fit + 1.96*pred_obj$se.fit))) %>%\n  mutate(cases_se=pred_obj$se.fit) %>%\n  mutate(cases_link=pred_obj$fit) #need to have this on link scale to bootstrap later\n\n\ndf2 <- df1 %>%\n  mutate(irrelevant=case_when(\n    covid==1 & month_num < covid_month_num ~ T,\n    TRUE ~ F\n  )) %>%\n  filter(irrelevant!=T) %>%  #get rid of \"COVID\"=yes when time is before COVID (irrelevant predictions)\n  select(-irrelevant) %>%\n  mutate(c_fact=case_when(\n        covid==0 & month_num >= covid_month_num ~ T, \n        T ~ F))\ndf2\n}\n\n\n\n2. Get data into required format\nNB. “All” is grouped data of total number of TB cases by month.\n\n\ntb_data <- tb_data_group %>% uncount(n) %>% mutate(month=dmy(month)) %>% mutate(fac=factor(fac),\n                                                                                sex = factor(sex),\n                                                                                hiv = factor(hiv))\n\ncens_10yr <- cens %>% mutate(age_gp=case_when(\n  Age==\"[0,4)\" ~ \"0-14\",\n  Age==\"[5,9)\" ~ \"0-14\",\n  Age==\"[10,14)\" ~ \"0-14\",\n  Age==\"[15,19)\" ~ \"15-24\",\n  Age==\"[20,24)\" ~ \"15-24\",\n  Age==\"[25,29)\" ~ \"25-34\",\n  Age==\"[30,34)\" ~ \"25-34\",\n  Age==\"[35,39)\" ~ \"35-44\",\n  Age==\"[40,44)\" ~ \"35-44\",\n  Age==\"[45,49)\" ~ \"45-54\",\n  Age==\"[50,54)\" ~ \"45-54\",\n  Age==\"[55,59)\" ~ \"55-64\",\n  Age==\"[60,64)\" ~ \"55-64\",\n  Age==\"[60,64)\" ~ \"55-64\",\n  Age==\"[65,69)\" ~ \"65+\",\n  Age==\"[70,74)\" ~ \"65+\",\n  Age==\"[75, )\" ~ \"65+\"\n)) %>%\n  group_by(yq, age_gp, Sex) %>%\n  summarise(pop=sum(Population))\n\ncens_all <- cens %>%\n  group_by(yq) %>%\n  summarise(pop=sum(Population)) %>%\n  mutate(`0`=pop,  # so this is a slightly hacky way to get population demoninators for each month (the quarter denominator gets repeated the same three times, not ideal, but it doesn't make any difference.  For plotting the graph - where CNR is a continous variable, I interpolate population to avoid zigzags)\n         `1`=pop,\n         `2`=pop) %>%\n  pivot_longer(c(`0`,`1`,`2`),names_to=\"m\") %>%\n  mutate(m=as.numeric(m)) %>%\n  mutate(month=yq+months(m))\n\n# then this is dataframe lumping all cases togehter\nall <- tb_data %>% \n  group_by(month) %>%\n  summarise(cases=n()) %>% #generates cases per month\n  ungroup() %>%\n  mutate(covid = if_else(month >= covid_date_m, 1L,0L)) %>%\n  arrange(month) %>%\n  mutate(month_num = 1:n()) %>% #create a month_num variable to use in model (rather than actual date, so coefficients make sense)\n  left_join(cens_all) %>%\n  mutate(cnr=(cases/pop)*100000*12) # x12 to get annualised CNRs (NB. children included in both denominator and numerator here)\n\ncovid_month_num <- all %>% ungroup() %>% filter(month==covid_date_m) %>% select(month_num) %>% distinct() %>% as.numeric() # this is to that models stay correct even if choose to change \"covid_date_m\"\n\n\n\nDemographics\n\n\nall %>% summarise(sum(cases))\n\n\n# A tibble: 1 x 1\n  `sum(cases)`\n         <int>\n1        10274\n\ntb_data %>% nrow()\n\n\n[1] 10274\n\nb4covid_m <- all %>% filter(month<=dmy(\"01 March 2020\"))\nb4covid <- tb_data %>% filter(month<=dmy(\"01 March 2020\"))\n\nb4covid_m %>% arrange(cnr) %>% slice_tail(n=1)\n\n\n# A tibble: 1 x 9\n  month      cases covid month_num yq             pop     m   value\n  <date>     <int> <int>     <int> <date>       <dbl> <dbl>   <dbl>\n1 2016-11-01   259     0         6 2016-10-01 766737.     1 766737.\n# … with 1 more variable: cnr <dbl>\n\nb4covid_m %>% arrange(cnr) %>% slice_head(n=1)\n\n\n# A tibble: 1 x 9\n  month      cases covid month_num yq             pop     m   value\n  <date>     <int> <int>     <int> <date>       <dbl> <dbl>   <dbl>\n1 2019-10-01    95     0        41 2019-10-01 833097.     0 833097.\n# … with 1 more variable: cnr <dbl>\n\nb4covid %>% nrow()\n\n\n[1] 9199\n\nb4covid %>% tabyl(sex)\n\n\n    sex    n     percent valid_percent\n female 3561 0.387107294     0.3882468\n   male 5611 0.609957604     0.6117532\n   <NA>   27 0.002935102            NA\n\nb4covid %>% tabyl(hiv)\n\n\n      hiv    n    percent valid_percent\n negative 3279 0.35645179     0.3603693\n positive 5820 0.63267746     0.6396307\n     <NA>  100 0.01087075            NA\n\nb4covid %>% tabyl(fac)\n\n\n  fac    n   percent\n   hc 4310 0.4685292\n qech 4889 0.5314708\n\nModel for all TB cases\n\n\nm1_nb <-glm.nb(cases ~ covid + month_num + covid:I(month_num-covid_month_num) + offset(log(pop)), all)\n\nbroom::tidy(m1_nb, exp=T, conf.int = T) %>% gt()\n\n\nhtml {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#plgixkjoju .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#plgixkjoju .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 4px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#plgixkjoju .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#plgixkjoju .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#plgixkjoju .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#plgixkjoju .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#plgixkjoju .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#plgixkjoju .gt_group_heading {\n  padding: 8px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#plgixkjoju .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#plgixkjoju .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#plgixkjoju .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#plgixkjoju .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#plgixkjoju .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 12px;\n}\n\n#plgixkjoju .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#plgixkjoju .gt_first_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#plgixkjoju .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#plgixkjoju .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding: 4px;\n}\n\n#plgixkjoju .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#plgixkjoju .gt_sourcenote {\n  font-size: 90%;\n  padding: 4px;\n}\n\n#plgixkjoju .gt_left {\n  text-align: left;\n}\n\n#plgixkjoju .gt_center {\n  text-align: center;\n}\n\n#plgixkjoju .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#plgixkjoju .gt_font_normal {\n  font-weight: normal;\n}\n\n#plgixkjoju .gt_font_bold {\n  font-weight: bold;\n}\n\n#plgixkjoju .gt_font_italic {\n  font-style: italic;\n}\n\n#plgixkjoju .gt_super {\n  font-size: 65%;\n}\n\n#plgixkjoju .gt_footnote_marks {\n  font-style: italic;\n  font-size: 65%;\n}\nterm\n      estimate\n      std.error\n      statistic\n      p.value\n      conf.low\n      conf.high\n    (Intercept)\n      0.0003236993\n      0.039372603\n      -204.093577\n      0.000000e+00\n      0.0002996355\n      0.000349907\n    covid\n      0.6403553658\n      0.099365146\n      -4.485798\n      7.264146e-06\n      0.5266200632\n      0.779310109\n    month_num\n      0.9889841145\n      0.001479681\n      -7.486080\n      7.096098e-14\n      0.9861008442\n      0.991873419\n    covid:I(month_num - covid_month_num)\n      1.0439775426\n      0.018821477\n      2.286642\n      2.221673e-02\n      1.0058566856\n      1.083617001\n    \n\ncoeff <- broom::tidy(m1_nb, exp=T, conf.int = T)\n\n1 - coeff[2,2]\n\n\n   estimate\n1 0.3596446\n\n1 - coeff[2,6]\n\n\n   conf.low\n1 0.4733799\n\n1 - coeff[2,7]\n\n\n  conf.high\n1 0.2206899\n\nMake and plot predictions\n\n\nm1_nb_all <- model2pred_pop(all,m1_nb) #this is used to make cumulative predictions\n\nm1_nb_all_continuous <- model2pred_pop_continuous(all,m1_nb) # this is used to plot\n\n# Plotting the whole timescale (treating time as continuous)\n\n# the below bit of code (and 'plot df' is a slightly hack-y way to make 'seq' correspond to real dates to be able to plot)\ncT <- m1_nb_all_continuous %>% filter(c_fact==T) # creating a sequence of dates to match month_num (a continuous numerical value)\nstart_cT <- min(cT$month, na.rm=T)\nend_cT <- max(cT$month, na.rm=T) + months(1) - days(1) # the end date needs to be the END of the month, not the start of the month\nlength_cT <- cT %>% nrow()\nseq_cT <- seq.Date(start_cT,end_cT,length.out = length_cT) \n\ncF <- m1_nb_all_continuous %>% filter(c_fact==F)\nstart_cF <- min(cF$month, na.rm=T)\nend_cF <- max(cF$month, na.rm=T) + months(1) - days(1)\nlength_cF <- cF %>% nrow()\nseq_cF <- seq.Date(start_cF,end_cF,length.out = length_cF) \n\nseq <- c(seq_cF, seq_cT)\n\nplot_df <- m1_nb_all_continuous %>% arrange(c_fact,month_num) %>% cbind(seq) # \"plot df\" has month_num transformed to actual date\n\n# Plot observed values and predictions\nggplot() +\ngeom_rect(aes(xmin=covid_date_m, xmax=dmy(\"31 Dec 2020\"), ymin=-Inf, ymax=Inf), alpha=0.1) +\ngeom_line(aes(y=cnr_pred, x=seq, linetype=\"observed\", color=\"observed\"), data=plot_df %>% filter(c_fact==F)) +\ngeom_ribbon(aes(ymax=cnr_high, ymin=cnr_low, x=seq, fill=\"observed\"), alpha=0.3, data=plot_df %>% filter(c_fact==F)) +\ngeom_line(aes(y=cnr_pred, x=seq, linetype=\"counterfactual\", color=\"counterfactual\"), data=plot_df %>% filter(c_fact==T)) +\ngeom_ribbon(aes(ymax=cnr_high, ymin=cnr_low, x=seq, fill=\"counterfactual\"), alpha=0.3, data=plot_df %>% filter(c_fact==T)) +\n  geom_point(aes(y=cnr_actual, x=month+days(15)), data=plot_df, shape=1) + # plot actual numbers on 15th each month\n  #geom_vline(aes(xintercept=covid_date_m)) +\n  scale_linetype_manual(name=\"legend\",values=c(\"dashed\",\"solid\")) +\n  scale_fill_manual(name=\"legend\", values=c(\"#DE3163\",\"#3FE0D0\")) +\n  scale_color_manual(name=\"legend\", values=c(\"#DE3163\",\"#4286f4\")) +\n  ylab(\"Case Notification Rate (per 100,000 person-years)\") +\n    xlab(\"Month and Year\") +\n   labs(title=\"Blantyre TB Case Notifcation Rate\",\n       caption=\"CNR = Cases TB notified per 100,000 person-years, \\n Dots = observed case notification rate \\n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \\n Shaded area indicates time that COVID emergency was declared in Malawi\") +\n  coord_cartesian(xlim=c(dmy(\"01 April 2016\"), dmy(\"31 Dec 2020\")),ylim=c(0,430)) +\n  scale_x_date(expand = c(0,0)) + \n  theme_bw()  %+replace%\n    theme(legend.title = element_blank())\n\n\n\n\nAnd some examples of predications from model\n\n\nm1_nb_all %>% filter(month==dmy(\"01 March 2020\") | month==dmy(\"01 April 2020\")) %>% select(-month_num, -yq, -m, -pop, -value)\n\n\n# A tibble: 3 x 13\n  covid month      cases_actual cnr_actual cases_pred cnr_pred\n  <int> <date>            <int>      <dbl>      <dbl>    <dbl>\n1     0 2020-03-01          168       240.       163.     233.\n2     0 2020-04-01           NA        NA        162.     231.\n3     1 2020-04-01          107       152.       104.     148.\n# … with 7 more variables: cases_low <dbl>, cases_high <dbl>,\n#   cnr_low <dbl>, cnr_high <dbl>, cases_se <dbl>, cases_link <dbl>,\n#   c_fact <lgl>\n\nm1_nb_all %>% filter(month==dmy(\"01 Nov 2020\") | month==dmy(\"01 Dec 2020\")) %>% select(-month_num, -yq, -m, -pop, -value)\n\n\n# A tibble: 4 x 13\n  covid month      cases_actual cnr_actual cases_pred cnr_pred\n  <int> <date>            <int>      <dbl>      <dbl>    <dbl>\n1     0 2020-11-01           NA        NA        152.     214.\n2     1 2020-11-01          146       205.       132.     185.\n3     0 2020-12-01           NA        NA        151.     211.\n4     1 2020-12-01          111       156.       136.     191.\n# … with 7 more variables: cases_low <dbl>, cases_high <dbl>,\n#   cnr_low <dbl>, cnr_high <dbl>, cases_se <dbl>, cases_link <dbl>,\n#   c_fact <lgl>\n\nModel checking\n\n\nres1 <- residuals(m1_nb,type=\"deviance\")\nplot(all$month_num,res1,ylim=c(-5,10),pch=19,cex=0.7,col=grey(0.6),\n     main=\"Residuals over time\",ylab=\"Deviance residuals\",xlab=\"Date\")\n\n\n\n# Further check for autocorrelation by examining the autocorrelation and\n#   partial autocorrelation functions\nacf(res1)\n\n\n\npacf(res1)\n\n\n\n\nUse model to illustrate “missing cases” / missing CNR. Use parametric bootstrapping to get confidence intervals\n\n\n# c_fact = FALSE (from April to December) is a modelled estimate (with a CI), BUT, the model estimate and the actual observed value (i.e. 505 cases) is identical.  So going to use this as a constant, without a distribution.\n\nm1_nb_covidt <- m1_nb_all %>% filter(month>=covid_date_m) #only interested in time period after \"COVID time\"\n\n#NB. This is covid_no when you just return the modelled cases (on the link scale 'cases_link'); the next function replaces cases_link with a distribution with mean 'cases_link' and st. dev 'st.error' of fir\n\ncovid_no <- m1_nb_covidt %>% filter(c_fact==T) %>%\n  summarise(n_nocovid = sum(\n    exp(\n      cases_link\n      )))\n\nboot_fx <- function(df){\ncovid_yes <- df %>% filter(c_fact==F) %>%\n  summarise(n_actual = sum(cases_actual))\n\ncovid_no <- df %>% filter(c_fact==T) %>%\n  summarise(n_nocovid = sum(\n    exp(\n      as.numeric(pmap(list(cases_link,cases_se), function(mu, sd) rnorm(1, mu, sd))) \n      )))\n\nabs_diff <- covid_no - covid_yes\nrel_diff <- (covid_no - covid_yes) / covid_no\n\nas.numeric(c(covid_yes,covid_no,abs_diff,rel_diff))\n}\n\n# run once to check\nboot_fx(m1_nb_covidt) # col 1 = observed cases, col 2 = predicted under counterfactual, col 3 = abs difference, col 4 = rel diff (one replicate)\n\n\n[1] 1075.0000000 1437.5813802  362.5813802    0.2522162\n\n# now run 1000 times\nx <- boot(m1_nb_covidt,boot_fx,R=1000,sim=\"parametric\")\n\n# Plot output for predicted number of cases under counterfactual no-COVID\nplot(x, index=2)\n\n\n\nsd_x <- c(sd(x$t[,1]),sd(x$t[,2]),sd(x$t[,3]),sd(x$t[,4])) # boot command output is a vector of estimate for worst / actual / averted\n\n\n\n\n\n# Now generate estimates with CI (using point estimate from model (cases_pred) rather than mean of boot output, although should be v. similar)\ntable_fx <- function(df,sd){\n  covid_yes <- df %>% filter(c_fact==F) %>%\n  summarise(n_actual = sum(cases_actual)) %>%\n    mutate(str=n_actual)\n  \n  covid_no <- df %>% filter(c_fact==T) %>%\n  summarise(n = sum(\n    exp(\n      cases_link\n      ))) %>%\n    mutate(nhi = n + 1.96*sd[2],\n            nlo = n - 1.96*sd[2]) %>%\n    mutate(str = paste0(\n      round(n,digits=0),\" (\",round(nlo,digits=0),\" to \",round(nhi,digits=0),\")\"\n    ))\n  \n  abs_diff <- tibble(covid_no$n - covid_yes) %>%\n    rename(n=n_actual) %>%\n    mutate(\n    nhi = n + 1.96*sd[3],\n    nlo = n - 1.96*sd[3]) %>%\n  mutate(str = paste0(\n      round(n,digits=0),\" (\",round(nlo,digits=0),\" to \",round(nhi,digits=0),\")\"\n  ))\n  \n  rel_diff <- tibble((covid_no$n - covid_yes) / covid_no$n) %>%\n    rename(n=n_actual) %>%\n    mutate(\n    nhi = n + 1.96*sd[4],\n    nlo = n - 1.96*sd[4]) %>%\n  mutate(str = paste0(\n      round(n,digits=3),\" (\",round(nlo,digits=3),\" to \",round(nhi,digits=3),\")\"\n  ))\n  \n  cbind(covid_yes$str, covid_no$str, abs_diff$str, rel_diff$str) %>% as_tibble() %>%\n    rename(covid_yes=V1,\n           covid_no=V2,\n           rel.diff = V3,\n           abs.diff = V4)\n}\n\ntable_fx(m1_nb_covidt,sd_x) %>% gt()\n\n\nhtml {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#ynwlesfxen .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ynwlesfxen .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 4px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ynwlesfxen .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ynwlesfxen .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ynwlesfxen .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ynwlesfxen .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ynwlesfxen .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ynwlesfxen .gt_group_heading {\n  padding: 8px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ynwlesfxen .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ynwlesfxen .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ynwlesfxen .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ynwlesfxen .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ynwlesfxen .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 12px;\n}\n\n#ynwlesfxen .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ynwlesfxen .gt_first_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ynwlesfxen .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ynwlesfxen .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding: 4px;\n}\n\n#ynwlesfxen .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ynwlesfxen .gt_sourcenote {\n  font-size: 90%;\n  padding: 4px;\n}\n\n#ynwlesfxen .gt_left {\n  text-align: left;\n}\n\n#ynwlesfxen .gt_center {\n  text-align: center;\n}\n\n#ynwlesfxen .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ynwlesfxen .gt_font_normal {\n  font-weight: normal;\n}\n\n#ynwlesfxen .gt_font_bold {\n  font-weight: bold;\n}\n\n#ynwlesfxen .gt_font_italic {\n  font-style: italic;\n}\n\n#ynwlesfxen .gt_super {\n  font-size: 65%;\n}\n\n#ynwlesfxen .gt_footnote_marks {\n  font-style: italic;\n  font-size: 65%;\n}\ncovid_yes\n      covid_no\n      rel.diff\n      abs.diff\n    1075\n      1408 (1367 to 1450)\n      333 (292 to 375)\n      0.237 (0.214 to 0.259)\n    \n\nm1_nb_covidt %>% filter(c_fact==T) %>% summarise(mean=mean(cnr_pred))\n\n\n# A tibble: 1 x 1\n   mean\n  <dbl>\n1  221.\n\n3. Now to break this down by demographics\nHealth centre, sex and HIV status. Cases rather than CNR, as don’t have denominators for health centre or HIV status\n\n\n# Impute the small number of missing variables\ntb_data_mids <- mice(\n  data=tb_data,\n  m=1, #just one imputation as missing data v. small\n  method=\"pmm\"\n)\n\n\n\n iter imp variable\n  1   1  sex  hiv\n  2   1  sex  hiv\n  3   1  sex  hiv\n  4   1  sex  hiv\n  5   1  sex  hiv\n\ntb_data_imp <- complete(tb_data_mids, action=\"long\") %>% select(-.imp, -.id) #complete data set\n\nby <- tb_data_imp %>%\n    group_by(month,sex,hiv,fac) %>%\n    summarise(cases=n()) %>%\n    ungroup() %>%\n    mutate(covid = if_else(month >= covid_date_m, 1L,0L)) %>%\n    arrange(month) %>%\n    group_by(month) %>%\n    mutate(month_num = cur_group_id()) %>%\n    ungroup()\n\nm2 <-glm.nb(cases ~ sex + hiv + fac + sex:hiv:fac + sex:hiv:fac:covid + sex:hiv:fac:month_num + sex:hiv:fac:covid:I(month_num-covid_month_num), data=by) \n\ntidy(m2, exp=T, conf.int = T) %>% gt()\n\n\nhtml {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#mcxkblxqds .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#mcxkblxqds .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 4px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#mcxkblxqds .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#mcxkblxqds .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#mcxkblxqds .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#mcxkblxqds .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#mcxkblxqds .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#mcxkblxqds .gt_group_heading {\n  padding: 8px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#mcxkblxqds .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#mcxkblxqds .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#mcxkblxqds .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#mcxkblxqds .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#mcxkblxqds .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 12px;\n}\n\n#mcxkblxqds .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mcxkblxqds .gt_first_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#mcxkblxqds .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#mcxkblxqds .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding: 4px;\n}\n\n#mcxkblxqds .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#mcxkblxqds .gt_sourcenote {\n  font-size: 90%;\n  padding: 4px;\n}\n\n#mcxkblxqds .gt_left {\n  text-align: left;\n}\n\n#mcxkblxqds .gt_center {\n  text-align: center;\n}\n\n#mcxkblxqds .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#mcxkblxqds .gt_font_normal {\n  font-weight: normal;\n}\n\n#mcxkblxqds .gt_font_bold {\n  font-weight: bold;\n}\n\n#mcxkblxqds .gt_font_italic {\n  font-style: italic;\n}\n\n#mcxkblxqds .gt_super {\n  font-size: 65%;\n}\n\n#mcxkblxqds .gt_footnote_marks {\n  font-style: italic;\n  font-size: 65%;\n}\nterm\n      estimate\n      std.error\n      statistic\n      p.value\n      conf.low\n      conf.high\n    (Intercept)\n      11.5682613\n      0.192838705\n      12.69592250\n      6.229160e-37\n      7.9042010\n      16.9111105\n    sexmale\n      1.4474150\n      0.100884418\n      3.66537463\n      2.469768e-04\n      1.1856677\n      1.7673495\n    hivpositive\n      2.4921744\n      0.109810004\n      8.31577778\n      9.115248e-17\n      2.0102265\n      3.0925538\n    facqech\n      1.4340115\n      0.100884422\n      3.57315552\n      3.527051e-04\n      1.1749379\n      1.7506146\n    sexfemale:hivnegative:fachc\n      1.0206506\n      0.217852134\n      0.09382613\n      9.252473e-01\n      0.6642900\n      1.5684400\n    sexmale:hivnegative:fachc\n      1.5151800\n      0.154147308\n      2.69569568\n      7.024181e-03\n      1.1205023\n      2.0493665\n    sexfemale:hivpositive:fachc\n      0.8914292\n      0.150287341\n      -0.76473002\n      4.444323e-01\n      0.6622342\n      1.1996924\n    sexmale:hivpositive:fachc\n      NA\n      NA\n      NA\n      NA\n      NA\n      NA\n    sexfemale:hivnegative:facqech\n      0.9832463\n      0.164035493\n      -0.10299973\n      9.179632e-01\n      0.7118945\n      1.3572887\n    sexmale:hivnegative:facqech\n      NA\n      NA\n      NA\n      NA\n      NA\n      NA\n    sexfemale:hivpositive:facqech\n      NA\n      NA\n      NA\n      NA\n      NA\n      NA\n    sexmale:hivpositive:facqech\n      NA\n      NA\n      NA\n      NA\n      NA\n      NA\n    sexfemale:hivnegative:fachc:covid\n      0.4991993\n      0.282092709\n      -2.46284264\n      1.378404e-02\n      0.2807735\n      0.8565982\n    sexmale:hivnegative:fachc:covid\n      0.6571969\n      0.190951350\n      -2.19831715\n      2.792651e-02\n      0.4502135\n      0.9550982\n    sexfemale:hivpositive:fachc:covid\n      0.6096585\n      0.247231918\n      -2.00158736\n      4.532913e-02\n      0.3715020\n      0.9785294\n    sexmale:hivpositive:fachc:covid\n      0.6480760\n      0.202645855\n      -2.14042027\n      3.232082e-02\n      0.4326924\n      0.9629001\n    sexfemale:hivnegative:facqech:covid\n      0.5421471\n      0.306924115\n      -1.99468824\n      4.607689e-02\n      0.2885525\n      0.9726948\n    sexmale:hivnegative:facqech:covid\n      0.6447441\n      0.241977617\n      -1.81381172\n      6.970672e-02\n      0.3965319\n      1.0275156\n    sexfemale:hivpositive:facqech:covid\n      0.6673820\n      0.197849197\n      -2.04394415\n      4.095906e-02\n      0.4495570\n      0.9840863\n    sexmale:hivpositive:facqech:covid\n      0.6994277\n      0.185914310\n      -1.92289071\n      5.449378e-02\n      0.4845232\n      1.0055719\n    sexfemale:hivnegative:fachc:month_num\n      1.0032003\n      0.003707896\n      0.86172439\n      3.888392e-01\n      0.9958843\n      1.0105793\n    sexmale:hivnegative:fachc:month_num\n      1.0047130\n      0.002900554\n      1.62106168\n      1.050044e-01\n      0.9991064\n      1.0103592\n    sexfemale:hivpositive:fachc:month_num\n      0.9880795\n      0.003237245\n      -3.70443120\n      2.118656e-04\n      0.9817517\n      0.9944184\n    sexmale:hivpositive:fachc:month_num\n      0.9895807\n      0.002805365\n      -3.73353915\n      1.888078e-04\n      0.9840929\n      0.9950830\n    sexfemale:hivnegative:facqech:month_num\n      0.9865843\n      0.003814012\n      -3.54128552\n      3.981824e-04\n      0.9791794\n      0.9939974\n    sexmale:hivnegative:facqech:month_num\n      0.9881350\n      0.003304539\n      -3.61199987\n      3.038447e-04\n      0.9817762\n      0.9945050\n    sexfemale:hivpositive:facqech:month_num\n      0.9903053\n      0.002799128\n      -3.48036450\n      5.007320e-04\n      0.9848125\n      0.9958134\n    sexmale:hivpositive:facqech:month_num\n      0.9849039\n      0.002658260\n      -5.72223395\n      1.051324e-08\n      0.9797209\n      0.9900946\n    sexfemale:hivnegative:fachc:covid:I(month_num - covid_month_num)\n      0.9726919\n      0.056988957\n      -0.48584754\n      6.270753e-01\n      0.8684701\n      1.0885607\n    sexmale:hivnegative:fachc:covid:I(month_num - covid_month_num)\n      0.9977264\n      0.036736922\n      -0.06195886\n      9.505956e-01\n      0.9277265\n      1.0730474\n    sexfemale:hivpositive:fachc:covid:I(month_num - covid_month_num)\n      1.0407859\n      0.047241179\n      0.84621354\n      3.974336e-01\n      0.9494280\n      1.1416900\n    sexmale:hivpositive:fachc:covid:I(month_num - covid_month_num)\n      1.0175961\n      0.039192492\n      0.44506076\n      6.562758e-01\n      0.9417458\n      1.0996888\n    sexfemale:hivnegative:facqech:covid:I(month_num - covid_month_num)\n      1.1008144\n      0.056097551\n      1.71220025\n      8.685977e-02\n      0.9858711\n      1.2324208\n    sexmale:hivnegative:facqech:covid:I(month_num - covid_month_num)\n      1.0945064\n      0.044228367\n      2.04175590\n      4.117575e-02\n      1.0037741\n      1.1951421\n    sexfemale:hivpositive:facqech:covid:I(month_num - covid_month_num)\n      1.0368200\n      0.037630942\n      0.96086734\n      3.366189e-01\n      0.9622314\n      1.1175599\n    sexmale:hivpositive:facqech:covid:I(month_num - covid_month_num)\n      1.0821023\n      0.034547361\n      2.28398582\n      2.237236e-02\n      1.0115490\n      1.1582752\n    \n\ncoeffs2 <- tidy(m2, exp=T, conf.int = T)\n\n\n\nCheck model\n\n\nres2 <- residuals(m2,type=\"deviance\")\nplot(by$month_num,res2,ylim=c(-5,10),pch=19,cex=0.7,col=grey(0.6),\n     main=\"Residuals over time\",ylab=\"Deviance residuals\",xlab=\"Date\")\n\n\n\n# Further check for autocorrelation by examining the autocorrelation and\n#   partial autocorrelation functions\nacf(res2)\n\n\n\npacf(res2)\n\n\n\n\nMake predictions and plot them\n\n\nm2_by <- model2pred_by(by,m2)\nm2_by_continuous <- model2pred_by_continuous(by,m2)\n\n# the below bit of code (and 'plot df' is a slightly hack-y way to make 'seq' correspond to real dates to be able to plot)\ncTb <- m2_by_continuous %>% filter(c_fact==T) # creating a sequence of dates to match month_num (a continuous numerical value)\nstart_cTb <- min(cTb$month, na.rm=T)\nend_cTb <- max(cTb$month, na.rm=T) + months(1) - days(1) # the end date needs to be the END of the month, not the start of the month\nlength_cTb <- cTb %>% nrow()\nseq_cTb <- seq.Date(start_cTb,end_cTb,length.out = length_cTb) \n\ncFb <- m2_by_continuous %>% filter(c_fact==F)\nstart_cFb <- min(cFb$month, na.rm=T)\nend_cFb <- max(cFb$month, na.rm=T) + months(1) - days(1)\nlength_cFb <- cFb %>% nrow()\nseq_cFb <- seq.Date(start_cFb,end_cFb,length.out = length_cFb) \n\nseqb <- c(seq_cFb, seq_cTb)\n\nplot_df_by <- m2_by_continuous %>% arrange(c_fact,month_num) %>% cbind(seqb) # \"plot df\" has month_num transformed to actual date\n\n\nlabel_hc <- c( #labels for plot\n  hc = \"Health Centre\",\n  qech = \"Queen Elizabeth Central Hospital\"\n)\n\nlabel_hiv <- c( #labels for plot\n  negative=\"HIV Negative\",\n  positive=\"HIV Positive\"\n)\n\nggplot() +\n  geom_line(aes(y=cases_pred,x=seqb, color=sex), data=plot_df_by%>%filter(c_fact==F)) +\n  geom_ribbon(aes(ymax=cases_high, ymin=cases_low, x=seqb, fill=sex), alpha=0.3, data=plot_df_by %>% filter(c_fact==F)) +\n  geom_point(aes(y=cases_actual, x=month+days(15), color=sex), size=0.5, alpha=0.7, data=plot_df_by%>%filter(c_fact==F))+\n  geom_vline(xintercept=covid_date_m, linetype=\"dotted\") +\n  scale_fill_manual(name=\"legend\", values=c(\"#E58601\",\"#B40F20\")) +\n  scale_color_manual(name=\"legend\", values=c(\"#E58601\",\"#B40F20\")) +\n  ylab(\"Number of TB cases notified per month\") +\n  xlab(\"Month and Year\") +\n  labs(title=\"\",\n       caption=\"Dots = observed number of cases \\n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \\n Vertical lines indicates time that COVID emergency was declared in Malawi\") +\n  facet_grid(hiv~fac, \n             labeller=labeller(\n               fac=label_hc,\n               hiv=label_hiv\n             )) +\n  theme_bw() %+replace%\n    theme(legend.title = element_blank())\n\n\n\n\nUse model to make predictions by number\n\n\n# Point estimate of missing\nm2_by %>% group_by(month,c_fact) %>% summarise(n=sum(cases_pred)) %>% filter(month>=covid_date_m) %>% group_by(c_fact) %>% summarise(n=sum(n)) \n\n\n# A tibble: 2 x 2\n  c_fact     n\n  <lgl>  <dbl>\n1 FALSE  1075.\n2 TRUE   1427.\n\ny <- m2_by %>% group_by(month,c_fact) %>% summarise(n=sum(cases_pred)) %>% filter(month>=covid_date_m) %>% group_by(c_fact) %>% summarise(n=sum(n)) \ny[2,2] - y[1,2] \n\n\n         n\n1 351.9844\n\n# Boot-strappable function\nm2_by_covidt <- m2_by %>% filter(month>=covid_date_m)\n\nboot_fx_by <- function(df,var){\n  var <- enquo(var)\n\n  covid_yes <- df %>% \n    filter(c_fact==F) %>%\n    group_by(!!var) %>%\n    summarise(\n      n=sum(\n        cases_actual\n      ))\n \n  covid_no <- df %>%\n    filter(c_fact==T) %>%\n    group_by(!!var) %>%\n    summarise(\n      n=sum(\n        cases_pred\n      ))  \n  \n  abs_diff <- covid_no$n - covid_yes$n\n  rel_diff <- (covid_no$n - covid_yes$n) / covid_no$n\n  \n  covid_yes %>% left_join(covid_no,by=quo_name(var)) %>% cbind(abs_diff) %>% cbind(rel_diff) %>%\n    rename(covid_yes=n.x,\n           covid_no=n.y)\n}\n\n# Run each of these once to have a look\nboot_fx_by(m2_by_covidt,sex)\n\n\n     sex covid_yes covid_no abs_diff  rel_diff\n1 female       381 550.8405 169.8405 0.3083297\n2   male       694 876.1896 182.1896 0.2079340\n\nboot_fx_by(m2_by_covidt,hiv)\n\n\n       hiv covid_yes covid_no abs_diff  rel_diff\n1 negative       416 606.6919 190.6919 0.3143142\n2 positive       659 820.3382 161.3382 0.1966728\n\nboot_fx_by(m2_by_covidt,fac)\n\n\n   fac covid_yes covid_no  abs_diff  rel_diff\n1   hc       488 761.0615 273.06150 0.3587903\n2 qech       587 665.9686  78.96858 0.1185770\n\n\n\n# Annoyingly, I can't work out how to pass second variable within my function to \"boot\" (ie. can't add a var).\n# Go back to original boot function\n\n# Boot sex\n\nmale <- m2_by_covidt %>% filter(sex==\"male\")\nfemale <- m2_by_covidt %>% filter(sex==\"female\")\nhc <- m2_by_covidt %>% filter(fac==\"hc\")\nqech <- m2_by_covidt %>% filter(fac==\"qech\")\nhivpos <- m2_by_covidt %>% filter(hiv==\"positive\")\nhivneg <- m2_by_covidt %>% filter(hiv==\"negative\")\n\n\n\n# Then boot each one\nmale_res <- boot(male,boot_fx,R=1000,sim=\"parametric\")\nfemale_res <- boot(female,boot_fx,R=1000,sim=\"parametric\")\nhc_res <- boot(hc,boot_fx,R=1000,sim=\"parametric\")\nqech_res <- boot(qech,boot_fx,R=1000,sim=\"parametric\")\nhivpos_res <- boot(hivpos,boot_fx,R=1000,sim=\"parametric\")\nhivneg_res <- boot(hivneg,boot_fx,R=1000,sim=\"parametric\")\nall_res <- boot(m2_by_covidt, boot_fx, R=1000, sim=\"parametric\")\n\n#Get st. dev\nboot_sd <- function(var){\n  c(sd(var$t[,1]),sd(var$t[,2]),sd(var$t[,3]),sd(var$t[,4]))\n}\n\nsd_male <- boot_sd(male_res)\nsd_female <- boot_sd(female_res)\nsd_hc <- boot_sd(hc_res)\nsd_qech <- boot_sd(qech_res)\nsd_hivpos <- boot_sd(hivpos_res)\nsd_hivneg <- boot_sd(hivneg_res)\nsd_all <- boot_sd(all_res)\n\ntable_fx_2 <- function(df,df_sd){ #not using boot function results, as get the point estimate direct from model; but using boot st. devs\n  covid_yes <- df %>% filter(c_fact==F) %>%\n  summarise(n_actual = sum(cases_actual)) %>%\n    mutate(str=n_actual)\n  \n  covid_no <- df %>% filter(c_fact==T) %>%\n  summarise(n = sum(\n    exp(\n      cases_link\n      ))) %>%\n    mutate(nhi = n + 1.96*df_sd[2],\n            nlo = n - 1.96*df_sd[2]) %>%\n    mutate(str = paste0(\n      round(n,digits=0),\" (\",round(nlo,digits=0),\" to \",round(nhi,digits=0),\")\"\n    ))\n  \n  abs_diff <- tibble(covid_no$n - covid_yes) %>%\n    rename(n=n_actual) %>%\n    mutate(\n    nhi = n + 1.96*df_sd[3],\n    nlo = n - 1.96*df_sd[3]) %>%\n  mutate(str = paste0(\n      round(n,digits=0),\" (\",round(nlo,digits=0),\" to \",round(nhi,digits=0),\")\"\n  ))\n  \n  rel_diff <- tibble((covid_no$n - covid_yes) / covid_no$n) %>%\n    rename(n=n_actual) %>%\n    mutate(\n    nhi = n + 1.96*df_sd[4],\n    nlo = n - 1.96*df_sd[4]) %>%\n  mutate(str = paste0(\n      round(n,digits=3),\" (\",round(nlo,digits=3),\" to \",round(nhi,digits=3),\")\"\n  ))\n  \n  cbind(covid_yes$str, covid_no$str, abs_diff$str, rel_diff$str) %>% as_tibble() %>%\n    rename(covid_yes=V1,\n           covid_no=V2,\n           abs.diff = V3,\n          rel.diff = V4)\n}\n\ntable_fx_2(male,sd_male) %>%\n  bind_rows(table_fx_2(female,sd_female)) %>%\n  bind_rows(table_fx_2(hc,sd_hc)) %>%\n  bind_rows(table_fx_2(qech,sd_qech)) %>%\n  bind_rows(table_fx_2(hivpos,sd_hivpos)) %>%\n  bind_rows(table_fx_2(hivneg,sd_hivneg)) %>%\n  cbind(c(\"male\",\"female\",\"hc\",\"qech\",\"hivpos\",\"hivneg\")) %>% \n  rename(group = `c(\\\"male\\\", \\\"female\\\", \\\"hc\\\", \\\"qech\\\", \\\"hivpos\\\", \\\"hivneg\\\")`) %>%\n  select(group,everything()) %>%\n  gt()\n\n\nhtml {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#frarlriaqr .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#frarlriaqr .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 4px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#frarlriaqr .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#frarlriaqr .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#frarlriaqr .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#frarlriaqr .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#frarlriaqr .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#frarlriaqr .gt_group_heading {\n  padding: 8px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#frarlriaqr .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#frarlriaqr .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#frarlriaqr .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#frarlriaqr .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#frarlriaqr .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 12px;\n}\n\n#frarlriaqr .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#frarlriaqr .gt_first_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#frarlriaqr .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#frarlriaqr .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding: 4px;\n}\n\n#frarlriaqr .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#frarlriaqr .gt_sourcenote {\n  font-size: 90%;\n  padding: 4px;\n}\n\n#frarlriaqr .gt_left {\n  text-align: left;\n}\n\n#frarlriaqr .gt_center {\n  text-align: center;\n}\n\n#frarlriaqr .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#frarlriaqr .gt_font_normal {\n  font-weight: normal;\n}\n\n#frarlriaqr .gt_font_bold {\n  font-weight: bold;\n}\n\n#frarlriaqr .gt_font_italic {\n  font-style: italic;\n}\n\n#frarlriaqr .gt_super {\n  font-size: 65%;\n}\n\n#frarlriaqr .gt_footnote_marks {\n  font-style: italic;\n  font-size: 65%;\n}\ngroup\n      covid_yes\n      covid_no\n      abs.diff\n      rel.diff\n    male\n      694\n      876 (850 to 902)\n      182 (156 to 208)\n      0.208 (0.184 to 0.231)\n    female\n      381\n      551 (532 to 570)\n      170 (151 to 189)\n      0.308 (0.285 to 0.332)\n    hc\n      488\n      761 (736 to 786)\n      273 (248 to 298)\n      0.359 (0.338 to 0.38)\n    qech\n      587\n      666 (645 to 687)\n      79 (58 to 100)\n      0.119 (0.091 to 0.146)\n    hivpos\n      659\n      820 (796 to 844)\n      161 (137 to 185)\n      0.197 (0.173 to 0.22)\n    hivneg\n      416\n      607 (585 to 629)\n      191 (169 to 213)\n      0.314 (0.29 to 0.339)\n    \n\n\n\n# Table for everyone\ntable_fx_2(m2_by_covidt,sd_all) %>% gt()\n\n\nhtml {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#igpkbjffxy .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#igpkbjffxy .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 4px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#igpkbjffxy .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#igpkbjffxy .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#igpkbjffxy .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#igpkbjffxy .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#igpkbjffxy .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#igpkbjffxy .gt_group_heading {\n  padding: 8px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#igpkbjffxy .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#igpkbjffxy .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#igpkbjffxy .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#igpkbjffxy .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#igpkbjffxy .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 12px;\n}\n\n#igpkbjffxy .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#igpkbjffxy .gt_first_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#igpkbjffxy .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#igpkbjffxy .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding: 4px;\n}\n\n#igpkbjffxy .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#igpkbjffxy .gt_sourcenote {\n  font-size: 90%;\n  padding: 4px;\n}\n\n#igpkbjffxy .gt_left {\n  text-align: left;\n}\n\n#igpkbjffxy .gt_center {\n  text-align: center;\n}\n\n#igpkbjffxy .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#igpkbjffxy .gt_font_normal {\n  font-weight: normal;\n}\n\n#igpkbjffxy .gt_font_bold {\n  font-weight: bold;\n}\n\n#igpkbjffxy .gt_font_italic {\n  font-style: italic;\n}\n\n#igpkbjffxy .gt_super {\n  font-size: 65%;\n}\n\n#igpkbjffxy .gt_footnote_marks {\n  font-style: italic;\n  font-size: 65%;\n}\ncovid_yes\n      covid_no\n      abs.diff\n      rel.diff\n    1075\n      1427 (1394 to 1460)\n      352 (319 to 385)\n      0.247 (0.23 to 0.264)\n    \n\nSensitivity analysis\n\n\n# Harmonics for seasons\nsens1 <- glm.nb(cases ~ offset(log(pop)) + covid*month_num + harmonic(month_num,2,12), all)  # have to use month_num here as I can't get 'harmonic' to work sensibly with dates\n\ns1_all <- model2pred_pop(all,sens1)\n\nplot_all_fx <- function(df){\nggplot() +\ngeom_rect(aes(xmin=covid_date_m, xmax=dmy(\"15 Dec 2020\"), ymin=-Inf, ymax=Inf), alpha=0.1) +\ngeom_line(aes(y=cnr_pred, x=month, linetype=\"observed\", color=\"observed\"), data=df %>% filter(c_fact==F)) +\ngeom_ribbon(aes(ymax=cnr_high, ymin=cnr_low, x=month, fill=\"observed\"), alpha=0.3, data=df %>% filter(c_fact==F)) +\ngeom_line(aes(y=cnr_pred, x=month, linetype=\"counterfactual\", color=\"counterfactual\"), data=df %>% filter(c_fact==T)) +\ngeom_ribbon(aes(ymax=cnr_high, ymin=cnr_low, x=month, fill=\"counterfactual\"), alpha=0.3, data=df %>% filter(c_fact==T)) +\n  geom_point(aes(y=cnr_actual, x=month+days(15)), data=plot_df, shape=1) + # plot actual numbers on 15th each month\n  #geom_vline(aes(xintercept=covid_date_m)) +\n  scale_linetype_manual(name=\"legend\",values=c(\"dashed\",\"solid\")) +\n  scale_fill_manual(name=\"legend\", values=c(\"#DE3163\",\"#3FE0D0\")) +\n  scale_color_manual(name=\"legend\", values=c(\"#DE3163\",\"#4286f4\")) +\n  ylab(\"Case Notification Rate (per 100,000 person-years)\") +\n    xlab(\"Month and Year\") +\n   labs(title=\"Blantyre TB Case Notifcation Rate\",\n       caption=\"CNR = Cases TB notified per 100,000 person-years, \\n Dots = observed case notification rate \\n Line = fitted model (95% CI) with both step and slope change due to COVID, see methods for details \\n Shaded area indicates time that COVID emergency was declared in Malawi\") +\n  coord_cartesian(xlim=c(dmy(\"01 April 2016\"), dmy(\"15 Dec 2020\")),ylim=c(0,430)) +\n  scale_x_date(expand = c(0,0)) + \n  theme_bw()  %+replace%\n    theme(legend.title = element_blank())\n}\n\n\nplot_all_fx(s1_all)\n\n\n\ns1_covidt <- s1_all %>% filter(month>=covid_date_m) \nboot_fx(s1_covidt)\n\n\n[1] 1075.0000000 1424.9239975  349.9239975    0.2455738\n\nest_s1 <- boot(s1_covidt,boot_fx,R=100,sim=\"parametric\")\nsd_s1 <- c(sd(est_s1$t[,1]),sd(est_s1$t[,2]),sd(est_s1$t[,3]),sd(est_s1$t[,4])) # boot command output is a vector of estimate for worst / actual / averted\n\ntable_fx(s1_covidt,sd_s1)\n\n\n# A tibble: 1 x 4\n  covid_yes covid_no            rel.diff         abs.diff             \n  <chr>     <chr>               <chr>            <chr>                \n1 1075      1387 (1335 to 1438) 312 (260 to 363) 0.225 (0.196 to 0.25…\n\ntable_fx(m1_nb_covidt,sd_x)\n\n\n# A tibble: 1 x 4\n  covid_yes covid_no            rel.diff         abs.diff             \n  <chr>     <chr>               <chr>            <chr>                \n1 1075      1408 (1367 to 1450) 333 (292 to 375) 0.237 (0.214 to 0.25…\n\nm1_nb$aic\n\n\n[1] 519.1786\n\nsens1$aic #actually a little higher, no serious difference\n\n\n[1] 523.2373\n\n333/ all %>% filter(month>=dmy(\"01 April 2020\")) %>% summarise(m=median(pop)) *100000\n\n\n         m\n1 39.16637\n\n\n\n\n",
      "last_modified": "2021-04-19T22:18:44+02:00"
    },
    {
      "path": "index.html",
      "title": "TB COVID Blantyre",
      "description": "A website for our code and data about impact of COVID on TB notifications in Blantyre\n",
      "author": [],
      "contents": "\nThis is a website and github repository for our project about impact of COVID-19 on TB notifications in Blantyre, Malawi.\nThe github repo is at https://github.com/rachaelmburke/tbcovidblantyre\nHere you will find\nR markdown file with analyses\nKnitted R markdown file (same as the one on this webpage)\n.csv file of monthly total TB case notifications from June 2016 until December 2020\n.rdata file of modelled quarterly Blantyre population by age and sex (based on Govt of Malawi censuses in 2008 and 2018, with thanks to Chu Chang Ku)\n\n\n\n",
      "last_modified": "2021-04-19T22:18:45+02:00"
    }
  ],
  "collections": []
}
